<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–í—ñ–¥–µ–æ—á–∞—Ç ‚Äî –ö–û–ú–ê</title>
<link rel="icon" href="../icon/favicon.ico">
<style>
  :root{--brand:#0f5257;--border:#e5e7eb}
  body{margin:0;font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{background:linear-gradient(135deg,#0b2e33,#0f5257 60%,#6fc8b8);color:#fff;padding:12px 18px}
  .wrap{max-width:1100px;margin:16px auto;padding:0 18px;display:grid;grid-template-columns:2fr 1fr;gap:16px}
  @media (max-width:900px){.wrap{grid-template-columns:1fr}}
  .card{border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.06);background:#fff}
  .video{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:8px}
  video{width:100%;background:#000;border-radius:10px;min-height:220px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;padding:10px;border-top:1px solid var(--border)}
  button{padding:.7rem 1rem;border-radius:999px;border:1px solid var(--border);background:#fff;cursor:pointer}
  button[disabled]{opacity:.5;cursor:not-allowed}
  .primary{background:var(--brand);color:#fff;border-color:transparent}
  .muted{opacity:.7}
  .side{display:flex;flex-direction:column}
  .side > *{padding:12px}
  .chat{display:flex;flex-direction:column;height:360px;border-top:1px solid var(--border);gap:8px}
  .chatlog{flex:1;overflow:auto;background:#f9fafb;border:1px solid var(--border);border-radius:8px;padding:10px}
  .row{display:flex;gap:8px}
  input{flex:1;padding:.6rem;border:1px solid var(--border);border-radius:8px}
  .sys{color:#6b7280;font-size:.9rem;margin:.2rem 0}
  .me{ text-align:right }
</style>
</head>
<body>
<header><strong>–ö–û–ú–ê ‚Ä¢ –í—ñ–¥–µ–æ–∑—É—Å—Ç—Ä—ñ—á</strong> <span id="roomLabel" style="opacity:.85"></span></header>

<div class="wrap">
  <section class="card">
    <div class="video">
      <video id="remote" autoplay playsinline></video>
      <video id="local" autoplay playsinline muted></video>
    </div>
    <div class="controls">
      <button id="btnStart" class="primary">–ü—ñ–¥‚Äô—î–¥–Ω–∞—Ç–∏—Å—è</button>
      <button id="btnMic"  disabled>üéôÔ∏è –ú—ñ–∫—Ä–æ—Ñ–æ–Ω</button>
      <button id="btnCam"  disabled>üì∑ –ö–∞–º–µ—Ä–∞</button>
      <button id="btnScreen" disabled>üñ•Ô∏è –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è –µ–∫—Ä–∞–Ω–æ–º</button>
      <span id="status" class="muted">–ù–µ –ø—ñ–¥‚Äô—î–¥–Ω–∞–Ω–æ</span>
    </div>
  </section>

  <aside class="card side">
    <div><strong>–ß–∞—Ç</strong></div>
    <div class="chat">
      <div id="chatlog" class="chatlog"></div>
      <div class="row">
        <input id="msg" placeholder="–ù–∞–ø–∏—Å–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è‚Ä¶" disabled>
        <button id="send" disabled>–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
      </div>
    </div>
    <div style="border-top:1px solid var(--border)">
      <div class="muted" id="hint">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è‚Ä¶</div>
    </div>
  </aside>
</div>

<script>
/* ===== –ü–∞—Ä–∞–º–µ—Ç—Ä–∏ –∫—ñ–º–Ω–∞—Ç–∏ ===== */
const qs = new URLSearchParams(location.search);
const room = qs.get('room') ||
             `${(qs.get('consultant')||'room')}_${qs.get('date')||''}_${qs.get('time')||''}`.replace(/\s+/g,'');
document.getElementById('roomLabel').textContent = `‚Ä¢ –ö—ñ–º–Ω–∞—Ç–∞: ${room}`;

/* ===== –°–∏–≥–Ω–∞–ª—ñ–Ω–≥ (Render) ===== */
const RENDER_WSS = 'wss://koma-uaue.onrender.com';
const SIGNAL_URL = location.hostname === 'localhost' ? 'ws://localhost:3001' : RENDER_WSS;

/* ===== –ï–ª–µ–º–µ–Ω—Ç–∏ ===== */
const els = {
  local: document.getElementById('local'),
  remote: document.getElementById('remote'),
  start: document.getElementById('btnStart'),
  mic: document.getElementById('btnMic'),
  cam: document.getElementById('btnCam'),
  screen: document.getElementById('btnScreen'),
  status: document.getElementById('status'),
  chatlog: document.getElementById('chatlog'),
  msg: document.getElementById('msg'),
  send: document.getElementById('send'),
  hint: document.getElementById('hint'),
};

function logChat(text, who='sys'){
  const p = document.createElement('div');
  p.className = who === 'me' ? 'me' : (who === 'sys' ? 'sys' : '');
  p.textContent = text;
  els.chatlog.appendChild(p);
  els.chatlog.scrollTop = els.chatlog.scrollHeight;
}

/* ===== WebRTC ===== */
const pc = new RTCPeerConnection({ iceServers: [{ urls:'stun:stun.l.google.com:19302' }] });
let localStream, screenTrack, dc;

pc.ondatachannel = (e) => { dc = e.channel; bindDataChannel(); };
pc.onicecandidate = ({candidate}) => { if (candidate) wsSend({ type:'ice', room, payload: candidate }); };
pc.ontrack = ({streams}) => { els.remote.srcObject = streams[0]; els.status.textContent = '–ó‚Äô—î–¥–Ω–∞–Ω–æ'; };
pc.onconnectionstatechange = () => {
  els.status.textContent = '–°—Ç–∞—Ç—É—Å: ' + pc.connectionState;
  if (pc.connectionState === 'connected') {
    els.start.textContent = '–ó‚Äô—î–¥–Ω–∞–Ω–æ';
    els.start.disabled = true;
  }
};

/* ===== –î–æ—Å—Ç—É–ø –¥–æ –¥–µ–≤–∞–π—Å—ñ–≤ (—ñ–∑ –∑–∞—Ö–∏—Å—Ç–æ–º –≤—ñ–¥ NotReadableError) ===== */
async function startLocal(constraints = {audio:true, video:true}){
  // –Ø–∫—â–æ –≤–∂–µ —î ‚Äî –Ω–µ –¥—É–±–ª—é—î–º–æ
  if (localStream) return localStream;

  try {
    localStream = await navigator.mediaDevices.getUserMedia(constraints);
  } catch (err) {
    if (err && err.name === 'NotReadableError') {
      // –ö–∞–º–µ—Ä–∞/–º—ñ–∫—Ä–æ—Ñ–æ–Ω –∑–∞–π–Ω—è—Ç—ñ. –ü—Ä–æ–±—É—î–º–æ audio-only —ñ –ø–æ–ø–µ—Ä–µ–¥–∂–∞—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.
      logChat('–ö–∞–º–µ—Ä–∞/–º—ñ–∫—Ä–æ—Ñ–æ–Ω –∑–∞–π–Ω—è—Ç—ñ —ñ–Ω—à–æ—é –≤–∫–ª–∞–¥–∫–æ—é –∞–±–æ –¥–æ–¥–∞—Ç–∫–æ–º. ' +
              '–°–ø—Ä–æ–±–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –ª–∏—à–µ –∑ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–æ–º‚Ä¶', 'sys');
      els.hint.textContent = '–ö–∞–º–µ—Ä–∞ –∑–∞–π–Ω—è—Ç–∞. –ó–∞–∫—Ä–∏–π—Ç–µ —ñ–Ω—à—ñ –≤–∫–ª–∞–¥–∫–∏ –∑ –≤—ñ–¥–µ–æ –∞–±–æ –¥–æ–∑–≤–æ–ª—å—Ç–µ –¥–æ—Å—Ç—É–ø. –í–∏–∫–æ—Ä–∏—Å—Ç–∞—î–º–æ –ª–∏—à–µ –º—ñ–∫—Ä–æ—Ñ–æ–Ω.';
      try {
        localStream = await navigator.mediaDevices.getUserMedia({audio:true, video:false});
      } catch (e2) {
        logChat('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –Ω–∞–≤—ñ—Ç—å –º—ñ–∫—Ä–æ—Ñ–æ–Ω: ' + (e2.message||e2.name), 'sys');
        throw e2;
      }
    } else {
      logChat('–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤: ' + (err.message||err.name), 'sys');
      throw err;
    }
  }

  // –î–æ–¥–∞—î–º–æ –¥–æ—Ä—ñ–∂–∫–∏ –¥–æ PeerConnection
  localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
  els.local.srcObject = localStream;

  // –£–≤—ñ–º–∫–Ω–µ–º–æ –∫–µ—Ä—É–≤–∞–Ω–Ω—è –∫–Ω–æ–ø–∫–∞–º–∏
  els.mic.disabled = false;
  els.cam.disabled = !localStream.getVideoTracks().length;
  els.screen.disabled = false;

  return localStream;
}

async function makeOffer(){
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  wsSend({ type:'offer', room, payload: pc.localDescription });
}

/* ===== WebSocket (—Å–∏–≥–Ω–∞–ª—ñ–Ω–≥) ===== */
let ws;
function wsSend(obj){ if(ws && ws.readyState===1) ws.send(JSON.stringify(obj)); }

function connectWS(){
  ws = new WebSocket(SIGNAL_URL);

  ws.addEventListener('open', () => {
    wsSend({ type:'join', room });
    els.hint.textContent = '–ü—ñ–¥‚Äô—î–¥–Ω—É–π—Ç–µ—Å—å —ñ —á–µ–∫–∞–π—Ç–µ –Ω–∞ —Å–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫–∞.';
    logChat('–ü—ñ–¥‚Äô—î–¥–Ω–∞–Ω–æ –¥–æ —Å–∏–≥–Ω–∞–ª—ñ–Ω–≥—É', 'sys');
  });

  ws.addEventListener('message', async (e) => {
    const msg = JSON.parse(e.data);
    switch(msg.type){
      case 'joined': break;
      case 'offer': {
        await startLocal();
        await pc.setRemoteDescription(new RTCSessionDescription(msg.payload));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        wsSend({ type:'answer', room, payload: pc.localDescription });
        break;
      }
      case 'answer': {
        if (!pc.currentRemoteDescription)
          await pc.setRemoteDescription(new RTCSessionDescription(msg.payload));
        break;
      }
      case 'ice': {
        try { await pc.addIceCandidate(msg.payload); } catch {}
        break;
      }
      case 'bye': {
        els.remote.srcObject = null;
        logChat('–°–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫ –ø–æ–∫–∏–Ω—É–≤ –∫—ñ–º–Ω–∞—Ç—É', 'sys');
        break;
      }
    }
  });

  ws.addEventListener('close', () => { logChat('–°–∏–≥–Ω–∞–ª—ñ–Ω–≥ –≤—ñ–¥–∫–ª—é—á–µ–Ω–æ', 'sys'); });
}
connectWS();

/* ===== DataChannel / —á–∞—Ç ===== */
function bindDataChannel(){
  if (!dc) return;
  dc.onmessage = (e)=> logChat(e.data, 'peer');
  dc.onopen    = ()=>{
    els.hint.textContent = '–ß–∞—Ç –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ';
    els.msg.disabled = false;
    els.send.disabled = false;
    logChat('–ß–∞—Ç –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ', 'sys');
  };
  dc.onclose   = ()=>{
    els.msg.disabled = true;
    els.send.disabled = true;
    logChat('–ß–∞—Ç –∑–∞–∫—Ä–∏—Ç–æ', 'sys');
  };
}

function sendChat(){
  const txt = els.msg.value.trim();
  if (!txt || !dc || dc.readyState!=='open') return;
  dc.send(txt);
  logChat(txt, 'me');
  els.msg.value = '';
}
els.send.onclick = sendChat;
els.msg.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); sendChat(); }});

/* ===== UI –ø–æ–¥—ñ—ó ===== */
els.start.onclick = async () => {
  try{
    await startLocal();             // 1) –∫–∞–º/–º—ñ–∫—Ä–æ—Ñ–æ–Ω
    if (!dc) {                      // 2) —Å—Ç–≤–æ—Ä—é—î–º–æ –≤–ª–∞—Å–Ω–∏–π DataChannel
      dc = pc.createDataChannel('chat');
      bindDataChannel();
    }
    await makeOffer();              // 3) —ñ–Ω—ñ—Ü—ñ—é—î–º–æ –≤–∏–∫–ª–∏–∫
    els.start.disabled = true;
    els.status.textContent = '–û—á—ñ–∫—É—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å‚Ä¶';
  }catch(err){
    els.status.textContent = '–ü–æ–º–∏–ª–∫–∞: ' + (err.message||err.name);
  }
};

els.mic.onclick = () => {
  if (!localStream) return;
  const track = localStream.getAudioTracks()[0];
  if (track){
    track.enabled = !track.enabled;
    els.mic.textContent = track.enabled ? 'üéôÔ∏è –ú—ñ–∫—Ä–æ—Ñ–æ–Ω' : 'üîá –ú—ñ–∫—Ä–æ—Ñ–æ–Ω';
  }
};

els.cam.onclick = () => {
  if (!localStream) return;
  const track = localStream.getVideoTracks()[0];
  if (track){
    track.enabled = !track.enabled;
    els.cam.textContent = track.enabled ? 'üì∑ –ö–∞–º–µ—Ä–∞' : 'üö´ –ö–∞–º–µ—Ä–∞';
  }
};

els.screen.onclick = async () => {
  try{
    const stream = await navigator.mediaDevices.getDisplayMedia({video:true});
    screenTrack = stream.getVideoTracks()[0];
    const sender = pc.getSenders().find(s=>s.track && s.track.kind==='video');
    if (sender) sender.replaceTrack(screenTrack);
    screenTrack.onended = () => {
      const cam = localStream && localStream.getVideoTracks()[0];
      if (sender && cam) sender.replaceTrack(cam);
    };
  }catch{}
};

/* ===== Cleanup ===== */
window.addEventListener('beforeunload', () => {
  try { wsSend({ type:'bye', room }); } catch {}
  if (dc) dc.close();
  pc.getSenders().forEach(s => s.track && s.track.stop());
  pc.close();
  ws && ws.close();
});
</script>
</body>
</html>
