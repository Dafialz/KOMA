<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–í—ñ–¥–µ–æ—á–∞—Ç ‚Äî –ö–û–ú–ê</title>
<link rel="icon" href="icon/favicon.ico">

  <link rel="stylesheet" href="css/main.css">

</head>
<body>
<div data-include="partials/header.html"></div>

<div class="wrap">
  <section class="card">
    <div class="video">
      <video id="remote" autoplay playsinline></video>
      <video id="local"  autoplay playsinline muted></video>
    </div>
    <div class="controls">
      <button id="btnStart" class="primary">–ü—ñ–¥‚Äô—î–¥–Ω–∞—Ç–∏—Å—è</button>
      <button id="btnMic"    disabled>üéôÔ∏è –ú—ñ–∫—Ä–æ—Ñ–æ–Ω</button>
      <button id="btnCam"    disabled>üì∑ –ö–∞–º–µ—Ä–∞</button>
      <button id="btnScreen" disabled>üñ•Ô∏è –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è –µ–∫—Ä–∞–Ω–æ–º</button>
      <button id="btnFullRemote">‚§¢ –ù–∞ –≤–µ—Å—å –µ–∫—Ä–∞–Ω (—Å–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫)</button>
      <button id="btnFullLocal">‚§¢ –ù–∞ –≤–µ—Å—å –µ–∫—Ä–∞–Ω (–º–æ—î)</button>
      <span id="status" class="muted">–ù–µ –ø—ñ–¥‚Äô—î–¥–Ω–∞–Ω–æ</span>
    </div>
  </section>

  <aside class="card side">
    <div><strong>–ß–∞—Ç</strong></div>
    <div class="chat">
      <div id="chatlog" class="chatlog"></div>
      <div class="row">
        <input id="msg" placeholder="–ù–∞–ø–∏—Å–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è‚Ä¶" disabled>
        <button id="send" disabled>–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
      </div>
    </div>
    <div style="border-top:1px solid var(--border)">
      <div class="muted" id="hint">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è‚Ä¶</div>
    </div>
  </aside>
</div>

<script>
/* ========= –î–æ–ø–æ–º—ñ–∂–Ω–µ ========= */
const qs = new URLSearchParams(location.search);
function makeRoomIdFromQS(qs){
  // –Ø–∫—â–æ room –ø–µ—Ä–µ–¥–∞–Ω–∏–π —è–≤–Ω–æ ‚Äî –±–µ—Ä–µ–º–æ –π–æ–≥–æ
  const r = qs.get('room');
  if (r) return decodeURIComponent(r);
  // –Ü–Ω–∞–∫—à–µ –±—É–¥—É—î–º–æ —Å—Ç–∞–±—ñ–ª—å–Ω–∏–π room –∑ consultant/date/time
  const consultant = (qs.get('consultant')||'').trim();
  const date = (qs.get('date')||'').trim();
  const time = (qs.get('time')||'').trim();
  const raw = `${consultant}__${date}__${time}`.replace(/\s+/g,'');
  return raw || 'KOMA_room';
}
const room   = makeRoomIdFromQS(qs);
const polite = true; // –æ–±–∏–¥–≤—ñ —Å—Ç–æ—Ä–æ–Ω–∏ ¬´–≤–≤—ñ—á–ª–∏–≤—ñ¬ª ‚Äî –º–µ–Ω—à–µ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤
document.getElementById('roomLabel').textContent = `‚Ä¢ –ö—ñ–º–Ω–∞—Ç–∞: ${room}`;
document.getElementById('roleLabel').textContent = '‚Ä¢ –†–æ–ª—å: —É—á–∞—Å–Ω–∏–∫';

/* ========= –°–∏–≥–Ω–∞–ª—ñ–Ω–≥ (Render) ========= */
const RENDER_WSS = 'wss://koma-uaue.onrender.com';
const SIGNAL_URL = (location.hostname === 'localhost') ? 'ws://localhost:3000' : RENDER_WSS;

/* ========= –ï–ª–µ–º–µ–Ω—Ç–∏ ========= */
const els = {
  local:  document.getElementById('local'),
  remote: document.getElementById('remote'),
  start:  document.getElementById('btnStart'),
  mic:    document.getElementById('btnMic'),
  cam:    document.getElementById('btnCam'),
  screen: document.getElementById('btnScreen'),
  fullRemote: document.getElementById('btnFullRemote'),
  fullLocal:  document.getElementById('btnFullLocal'),
  status: document.getElementById('status'),
  chatlog:document.getElementById('chatlog'),
  msg:    document.getElementById('msg'),
  send:   document.getElementById('send'),
  hint:   document.getElementById('hint'),
};
function logChat(text, who='sys'){
  const p = document.createElement('div');
  p.className = who === 'me' ? 'me' : (who === 'sys' ? 'sys' : '');
  p.textContent = text;
  els.chatlog.appendChild(p);
  els.chatlog.scrollTop = els.chatlog.scrollHeight;
}

/* ========= RTCPeerConnection ========= */
const pc = new RTCPeerConnection({
  iceServers: [
    { urls: ['stun:stun.l.google.com:19302','stun:global.stun.twilio.com:3478'] },
    // –ü—É–±–ª—ñ—á–Ω–∏–π TURN (—Ç—ñ–ª—å–∫–∏ –¥–ª—è —Ç–µ—Å—Ç—ñ–≤). –î–ª—è –ø—Ä–æ–¥ ‚Äî —Å–≤—ñ–π TURN.
    { urls:'turn:global.relay.metered.ca:80',  username:'openrelayproject', credential:'openrelayproject' },
    { urls:'turn:global.relay.metered.ca:443', username:'openrelayproject', credential:'openrelayproject' },
    { urls:'turn:global.relay.metered.ca:443?transport=tcp', username:'openrelayproject', credential:'openrelayproject' },
  ],
  // iceTransportPolicy: 'all' // –∑–Ω–∞—á–µ–Ω–Ω—è –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
});

// –§—ñ–∫—Å—É—î–º–æ m-lines –Ω–∞–ø–µ—Ä–µ–¥ (—Å—Ç–∞–±—ñ–ª—å–Ω—ñ—à—ñ SDP)
const txAudio = pc.addTransceiver('audio', { direction:'sendrecv' });
const txVideo = pc.addTransceiver('video', { direction:'sendrecv' });

let localStream, screenTrack, dc;
let makingOffer = false;
let ignoreOffer = false;
let isUnloading = false;

// –ü–æ–¥—ñ—ó PC
pc.onicecandidate = ({candidate}) => { if (candidate) wsSend({ type:'ice', room, payload: candidate }); };
pc.ontrack = ({streams}) => {
  if (!els.remote.srcObject) {
    els.remote.srcObject = streams[0];
  }
  // –¥–µ—è–∫—ñ –±—Ä–∞—É–∑–µ—Ä–∏ –≤–∏–º–∞–≥–∞—é—Ç—å —è–≤–Ω–æ–≥–æ play()
  els.remote.play?.().catch(()=>{});
  els.status.textContent = '–ó‚Äô—î–¥–Ω–∞–Ω–æ';
};
pc.onconnectionstatechange = () => {
  els.status.textContent = '–°—Ç–∞—Ç—É—Å: ' + pc.connectionState;
  if (pc.connectionState === 'connected') {
    els.start.textContent = '–ó‚Äô—î–¥–Ω–∞–Ω–æ'; els.start.disabled = true;
  }
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π ICE-restart –ø—Ä–∏ —Ñ–µ–π–ª—ñ
  if (pc.connectionState === 'failed') {
    logChat('–ó‚Äô—î–¥–Ω–∞–Ω–Ω—è –≤—Ç—Ä–∞—á–µ–Ω–æ. –ü—Ä–æ–±—É—î–º–æ –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏‚Ä¶','sys');
    restartIce();
  }
};
pc.ondatachannel = (e) => { dc = e.channel; bindDataChannel(); };
pc.oniceconnectionstatechange = () => { logChat('ICE: ' + pc.iceConnectionState, 'sys'); };
pc.onsignalingstatechange    = () => { logChat('Signaling: ' + pc.signalingState, 'sys'); };

async function restartIce(){
  try{
    const offer = await pc.createOffer({ iceRestart: true });
    await pc.setLocalDescription(offer);
    wsSend({ type:'offer', room, payload: pc.localDescription });
  }catch(e){ console.warn('ICE restart failed', e); }
}

/* ========= –î–µ–≤–∞–π—Å–∏ (fallback –Ω–∞ audio-only) ========= */
async function startLocal(constraints){
  if (localStream) return localStream;
  const base = constraints || {
    audio: { echoCancellation:true, noiseSuppression:true, autoGainControl:true },
    video: { width: {ideal:1280}, height:{ideal:720}, frameRate:{ideal:30} }
  };
  try {
    localStream = await navigator.mediaDevices.getUserMedia(base);
  } catch (err) {
    if (err && (err.name === 'NotReadableError' || err.name === 'NotAllowedError' || err.name === 'NotFoundError')) {
      logChat('–ö–∞–º–µ—Ä–∞/–º—ñ–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ. –°–ø—Ä–æ–±–∞ –ª–∏—à–µ –∑ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–æ–º‚Ä¶', 'sys');
      els.hint.textContent = '–ö–∞–º–µ—Ä–∞ –∑–∞–π–Ω—è—Ç–∞ –∞–±–æ –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–∞. –í–∏–∫–æ—Ä–∏—Å—Ç–∞—î–º–æ –ª–∏—à–µ –º—ñ–∫—Ä–æ—Ñ–æ–Ω.';
      localStream = await navigator.mediaDevices.getUserMedia({audio:true, video:false});
    } else {
      logChat('–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤: ' + (err.message||err.name), 'sys');
      throw err;
    }
  }
  const a = localStream.getAudioTracks()[0] || null;
  const v = localStream.getVideoTracks()[0] || null;
  if (a) await txAudio.sender.replaceTrack(a);
  if (v) await txVideo.sender.replaceTrack(v);

  els.local.srcObject = localStream;
  els.local.play?.().catch(()=>{});
  els.mic.disabled = !a;
  els.cam.disabled = !v;
  els.screen.disabled = false;
  return localStream;
}

/* ========= Perfect Negotiation ========= */
async function createAndSendOffer(){
  try{
    makingOffer = true;
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    wsSend({ type:'offer', room, payload: pc.localDescription });
  } finally {
    makingOffer = false;
  }
}

/* ========= WebSocket (—Å–∏–≥–Ω–∞–ª—ñ–Ω–≥) + —Ä–µ–∫–æ–Ω–µ–∫—Ç ========= */
let ws, wsReadyResolve;
const wsReady = new Promise(r => wsReadyResolve = r);
let reconnectTimer = null;

function wsSend(obj){ if(ws && ws.readyState===1) ws.send(JSON.stringify(obj)); }

function connectWS(){
  clearTimeout(reconnectTimer);
  ws = new WebSocket(SIGNAL_URL);

  ws.addEventListener('open', () => {
    wsReadyResolve?.(); // –¥–æ–∑–≤–æ–ª—è—î–º–æ —á–µ–∫–∞—Ç–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è
    wsSend({ type:'join', room });
    els.hint.textContent = '–ü—ñ–¥‚Äô—î–¥–Ω—É–π—Ç–µ—Å—å —ñ —á–µ–∫–∞–π—Ç–µ –Ω–∞ —Å–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫–∞.';
    logChat('–ü—ñ–¥‚Äô—î–¥–Ω–∞–Ω–æ –¥–æ —Å–∏–≥–Ω–∞–ª—ñ–Ω–≥—É', 'sys');
  });

  ws.addEventListener('message', async (e) => {
    const msg = JSON.parse(e.data);
    if (!msg || msg.room && msg.room !== room) return; // —ñ–≥–Ω–æ—Ä—É—î–º–æ —ñ–Ω—à—ñ –∫—ñ–º–Ω–∞—Ç–∏ (–Ω–∞ –≤—Å—è–∫–∏–π)

    if (msg.type === 'offer') {
      const offerDesc = new RTCSessionDescription(msg.payload);
      const collision = (makingOffer || pc.signalingState !== 'stable');
      ignoreOffer = !polite && collision; // –∑ –æ–±–æ–º–∞ polite —Ü–µ –∑–∞–≤–∂–¥–∏ false
      if (ignoreOffer) {
        logChat('–£–Ω–∏–∫–ª–∏ –∫–æ–ª—ñ–∑—ñ—ó offer/offer (—è ‚Äî —ñ–Ω—ñ—Ü—ñ–∞—Ç–æ—Ä)', 'sys');
        return;
      }
      if (collision) {
        await Promise.all([
          pc.setLocalDescription({type:'rollback'}),
          pc.setRemoteDescription(offerDesc)
        ]);
      } else {
        await pc.setRemoteDescription(offerDesc);
      }
      await startLocal(); // –≥–∞—Ä–∞–Ω—Ç—É—î–º–æ local tracks –ø–µ—Ä–µ–¥ answer
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      wsSend({ type:'answer', room, payload: pc.localDescription });
      return;
    }

    if (msg.type === 'answer') {
      if (!ignoreOffer) {
        await pc.setRemoteDescription(new RTCSessionDescription(msg.payload));
      }
      return;
    }

    if (msg.type === 'ice') {
      try { await pc.addIceCandidate(msg.payload); } catch {}
      return;
    }

    if (msg.type === 'bye') {
      els.remote.srcObject = null;
      logChat('–°–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫ –ø–æ–∫–∏–Ω—É–≤ –∫—ñ–º–Ω–∞—Ç—É', 'sys');
      return;
    }
  });

  ws.addEventListener('close', () => {
    logChat('–°–∏–≥–Ω–∞–ª—ñ–Ω–≥ –≤—ñ–¥–∫–ª—é—á–µ–Ω–æ', 'sys');
    if (!isUnloading) {
      reconnectTimer = setTimeout(connectWS, 1500); // –º‚Äô—è–∫–∏–π —Ä–µ–∫–æ–Ω–µ–∫—Ç
    }
  });
}
connectWS();

/* ========= DataChannel / —á–∞—Ç ========= */
function bindDataChannel(){
  if (!dc) return;
  dc.onmessage = (e)=> logChat(e.data, 'peer');
  dc.onopen = ()=>{
    els.hint.textContent = '–ß–∞—Ç –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ';
    els.msg.disabled = false;
    els.send.disabled = false;
    logChat('–ß–∞—Ç –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ', 'sys');
  };
  dc.onclose = ()=>{
    els.msg.disabled = true;
    els.send.disabled = true;
    logChat('–ß–∞—Ç –∑–∞–∫—Ä–∏—Ç–æ', 'sys');
  };
}
function sendChat(){
  const txt = els.msg.value.trim();
  if (!txt || !dc || dc.readyState!=='open') return;
  dc.send(txt);
  logChat(txt, 'me');
  els.msg.value = '';
}
els.send.onclick = sendChat;
els.msg.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); sendChat(); }});

/* ========= UI –ø–æ–¥—ñ—ó ========= */
els.start.onclick = async () => {
  try{
    await wsReady;               // —á–µ–∫–∞—î–º–æ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è WS
    await startLocal();          // –ø—Ä–æ—Å–∏–º–æ –º–µ–¥—ñ–∞–¥–æ—Å—Ç—É–ø
    if (!dc) { dc = pc.createDataChannel('chat'); bindDataChannel(); }
    await createAndSendOffer();  // —ñ–Ω—ñ—Ü—ñ—é—î–º–æ –∑‚Äô—î–¥–Ω–∞–Ω–Ω—è
    els.start.disabled = true;
    els.status.textContent = '–û—á—ñ–∫—É—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å‚Ä¶';
  }catch(err){
    els.status.textContent = '–ü–æ–º–∏–ª–∫–∞: ' + (err.message||err.name);
  }
};

els.mic.onclick = () => {
  const track = localStream && localStream.getAudioTracks()[0];
  if (track){
    track.enabled = !track.enabled;
    els.mic.textContent = track.enabled ? 'üéôÔ∏è –ú—ñ–∫—Ä–æ—Ñ–æ–Ω' : 'üîá –ú—ñ–∫—Ä–æ—Ñ–æ–Ω';
  }
};
els.cam.onclick = () => {
  const track = localStream && localStream.getVideoTracks()[0];
  if (!track) return;
  track.enabled = !track.enabled;
  els.cam.textContent = track.enabled ? 'üì∑ –ö–∞–º–µ—Ä–∞' : 'üö´ –ö–∞–º–µ—Ä–∞';
};
els.screen.onclick = async () => {
  try{
    const stream = await navigator.mediaDevices.getDisplayMedia({video:true});
    screenTrack = stream.getVideoTracks()[0];
    await txVideo.sender.replaceTrack(screenTrack);
    screenTrack.onended = async () => {
      const cam = localStream && localStream.getVideoTracks()[0];
      await txVideo.sender.replaceTrack(cam || null);
    };
  }catch{}
};

/* ========= –ü–æ–≤–Ω–æ–µ–∫—Ä–∞–Ω–Ω–∏–π —Ä–µ–∂–∏–º ========= */
function toggleFS(el){
  if (!document.fullscreenElement) el.requestFullscreen?.();
  else document.exitFullscreen?.();
}
els.fullRemote.addEventListener('click', ()=> toggleFS(els.remote));
els.fullLocal .addEventListener('click', ()=> toggleFS(els.local));
[els.remote, els.local].forEach(v => v.addEventListener('dblclick', ()=> toggleFS(v)));

/* ========= –ê–≤—Ç–æ—Å—Ç–∞—Ä—Ç (–æ–ø—Ü—ñ–π–Ω–æ ?autostart=1) ========= */
if (qs.get('autostart') === '1') {
  // –∑–∞–ø—É—Å—Ç–∏–º–æ –ø—ñ—Å–ª—è –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è WS (—â–æ–± –æ–¥—Ä–∞–∑—É –ø—ñ—à–ª–∞ offer)
  wsReady.then(()=> els.start.click()).catch(()=>{});
}

/* ========= Cleanup ========= */
window.addEventListener('beforeunload', () => {
  isUnloading = true;
  try { wsSend({ type:'bye', room }); } catch {}
  if (dc) dc.close();
  pc.getSenders().forEach(s => s.track && s.track.stop());
  pc.close();
  ws && ws.close();
});
</script>
  <script src="js/partials.js"></script>
</body>
</html>
