<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>–í—ñ–¥–µ–æ—á–∞—Ç ‚Äî –ö–û–ú–ê</title>
  <link rel="icon" href="icon/favicon.ico">
  <link rel="stylesheet" href="css/main.css">

  <style>
    .wrap{max-width:1100px;margin:16px auto;padding:0 18px;display:grid;grid-template-columns:2fr 1fr;gap:16px}
    @media (max-width:900px){.wrap{grid-template-columns:1fr}}
    .card{border:1px solid var(--border);border-radius:var(--radius,16px);background:#fff;box-shadow:var(--shadow,0 10px 30px rgba(0,0,0,.08))}
    .card.side{padding:16px}

    .video{position:relative;display:grid;grid-template-columns:1fr;gap:8px;padding:16px;border-bottom:1px solid var(--border)}
    .video video{width:100%;background:#000;border-radius:12px;min-height:220px;object-fit:cover}
    .video #local{position:absolute;right:16px;bottom:16px;width:220px;max-width:35%;border:2px solid #fff;box-shadow:0 6px 18px rgba(0,0,0,.35);border-radius:12px}
    @media (max-width:700px){.video #local{width:150px}}

    .controls{padding:12px 16px;display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .controls .btn{height:38px;padding:0 14px}
    .btn-group{display:inline-flex;gap:0}
    .btn-group .btn{border-radius:999px}
    .btn-group .btn:not(:first-child){margin-left:-8px}
    .btn-group .btn:focus{position:relative;z-index:1}
    .btn-pill{border-radius:999px}
    .btn.ghost{border:1px dashed var(--border)}
    .btn.active{outline:2px solid rgba(15,82,87,.25)}
    .controls .meta{margin-left:auto;display:flex;gap:10px;align-items:center;color:var(--muted,#4b5563);font-size:.95rem;flex-wrap:wrap}
    .badge{display:inline-flex;align-items:center;gap:6px;line-height:1;border-radius:999px;background:#eef6f6;color:#0f5257;padding:6px 10px;font-size:.85rem}
    .badge.muted{background:#f3f4f6;color:#6b7280}
    .badge.ok{background:#e8f8ef;color:#0f7a48}
    .badge.danger{background:#fde8e8;color:#b91c1c}

    .chat{margin-top:10px}
    .chatlog{
      display:flex; flex-direction:column; gap:6px;
      height:260px; overflow:auto; border:1px solid var(--border);
      border-radius:12px; padding:10px; background:#fafafa;
    }
    .msg{display:flex}
    .msg.me{justify-content:flex-end}
    .msg.peer{justify-content:flex-start}
    .msg.sys{justify-content:center}
    .bubble{
      max-width:85%; padding:8px 10px; border-radius:12px;
      background:#eef6f6; color:#0f5257; box-shadow:0 1px 0 rgba(0,0,0,.03);
    }
    .me .bubble{background:#e8f8ef;color:#0f7a48}
    .sys{color:#6b7280;font-size:.9rem}
    .name{display:block; font-size:.75rem; opacity:.8; margin-bottom:4px}
    .row{display:flex;gap:8px;margin-top:10px}
    .row input{flex:1;border:1px solid var(--border);border-radius:10px;padding:10px}
    .row .btn{height:40px}

    button:disabled,.btn[aria-disabled="true"]{opacity:.6;cursor:not-allowed}

    .unmute {
      position:absolute; left:50%; bottom:18px; transform:translateX(-50%);
      background:#0f5257;color:#fff;border:none;border-radius:999px;padding:10px 14px;
      font-size:.9rem; box-shadow:0 6px 18px rgba(0,0,0,.25); display:none;
    }
    .video.has-unmute .unmute{display:block}
  </style>
</head>
<body>

  <div data-include="partials/header.html"></div>

  <div class="wrap">
    <section class="card">
      <div class="video" id="videoWrap">
        <video id="remote" autoplay playsinline></video>
        <video id="local"  autoplay playsinline muted></video>
        <button id="btnUnmute" class="unmute">–£–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫</button>
      </div>

      <div class="controls">
        <button id="btnStart" class="btn green btn-pill">üîå –ü—ñ–¥‚Äô—î–¥–Ω–∞—Ç–∏—Å—è</button>

        <div class="btn-group" role="group" aria-label="–ü—Ä–∏—Å—Ç—Ä–æ—ó">
          <button id="btnMic"    class="btn gray"    disabled>üéôÔ∏è –ú—ñ–∫—Ä–æ—Ñ–æ–Ω</button>
          <button id="btnCam"    class="btn gray"    disabled>üì∑ –ö–∞–º–µ—Ä–∞</button>
          <button id="btnScreen" class="btn outline" disabled>üñ•Ô∏è –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—å –µ–∫—Ä–∞–Ω–æ–º</button>
        </div>

        <div class="btn-group" role="group" aria-label="–ï–∫—Ä–∞–Ω">
          <button id="btnFullRemote" class="btn ghost">‚§¢ –°–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫</button>
          <button id="btnFullLocal"  class="btn ghost">‚§¢ –ú–æ—î –≤—ñ–¥–µ–æ</button>
        </div>

        <div class="meta">
          <span id="status" class="badge muted">–ù–µ –ø—ñ–¥‚Äô—î–¥–Ω–∞–Ω–æ</span>
          <span id="roomLabel" class="badge"></span>
          <span id="roleLabel" class="badge"></span>
        </div>
      </div>
    </section>

    <aside class="card side">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
        <strong>–ß–∞—Ç</strong>
        <span class="badge muted" id="hint">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è‚Ä¶</span>
      </div>

      <div class="chat">
        <div id="chatlog" class="chatlog" role="log" aria-live="polite"></div>
        <div class="row">
          <input id="msg" placeholder="–ù–∞–ø–∏—Å–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è‚Ä¶" disabled>
          <button id="send" class="btn outline" disabled>–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
        </div>
      </div>
    </aside>
  </div>

  <!-- WebRTC adapter (–ø–æ–ª—ñ—Ñ—ñ–ª) -->
  <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>

  <script>
  /* ========= –î–æ–ø–æ–º—ñ–∂–Ω–µ ========= */
  const qs = new URLSearchParams(location.search);
  function makeRoomIdFromQS(qs){
    const r = qs.get('room');
    if (r) return decodeURIComponent(r);
    const consultant = (qs.get('consultant')||'').trim();
    const date = (qs.get('date')||'').trim();
    const time = (qs.get('time')||'').trim();
    const raw = `${consultant}__${date}__${time}`.replace(/\s+/g,'');
    return raw || 'KOMA_room';
  }
  const room   = makeRoomIdFromQS(qs);
  const polite = true;

  const rl = document.getElementById('roomLabel');
  const rr = document.getElementById('roleLabel');
  if (rl) rl.textContent = `–ö—ñ–º–Ω–∞—Ç–∞: ${room}`;
  if (rr) rr.textContent = '–†–æ–ª—å: —É—á–∞—Å–Ω–∏–∫';

  /* ========= –°–∏–≥–Ω–∞–ª—ñ–Ω–≥ ========= */
  const RENDER_WSS = 'wss://koma-uaue.onrender.com';
  const SIGNAL_URL = (location.hostname === 'localhost') ? 'ws://localhost:3000' : RENDER_WSS;

  /* ========= –ï–ª–µ–º–µ–Ω—Ç–∏ ========= */
  const els = {
    local:  document.getElementById('local'),
    remote: document.getElementById('remote'),
    start:  document.getElementById('btnStart'),
    mic:    document.getElementById('btnMic'),
    cam:    document.getElementById('btnCam'),
    screen: document.getElementById('btnScreen'),
    fullRemote: document.getElementById('btnFullRemote'),
    fullLocal:  document.getElementById('btnFullLocal'),
    status: document.getElementById('status'),
    chatlog:document.getElementById('chatlog'),
    msg:    document.getElementById('msg'),
    send:   document.getElementById('send'),
    hint:   document.getElementById('hint'),
    unmute: document.getElementById('btnUnmute'),
    vwrap:  document.getElementById('videoWrap'),
  };
  function setBadge(text, cls){
    if(!els.status) return;
    els.status.textContent = text;
    els.status.className = 'badge ' + (cls||'');
  }

  function logChat(text, who='sys'){
    const item = document.createElement('div');
    if (who === 'me')       item.className = 'msg me';
    else if (who === 'peer')item.className = 'msg peer';
    else                    item.className = 'msg sys';

    if (who === 'sys'){
      item.textContent = text;
    } else {
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      const name = document.createElement('span');
      name.className = 'name';
      name.textContent = who === 'me' ? '–Ø' : '–°–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫';
      const span = document.createElement('span');
      span.textContent = text;
      bubble.appendChild(name);
      bubble.appendChild(span);
      item.appendChild(bubble);
    }
    els.chatlog.appendChild(item);
    els.chatlog.scrollTop = els.chatlog.scrollHeight;
  }

  /* ========= RTCPeerConnection ========= */
  const pc = new RTCPeerConnection({
    iceServers: [
      { urls: ['stun:stun.l.google.com:19302','stun:global.stun.twilio.com:3478'] },
      { urls:'turn:global.relay.metered.ca:80',  username:'openrelayproject', credential:'openrelayproject' },
      { urls:'turn:global.relay.metered.ca:443', username:'openrelayproject', credential:'openrelayproject' },
      { urls:'turn:global.relay.metered.ca:443?transport=tcp', username:'openrelayproject', credential:'openrelayproject' },
    ],
  });

  const txAudio = pc.addTransceiver('audio', { direction:'sendrecv' });
  const txVideo = pc.addTransceiver('video', { direction:'sendrecv' });

  let localStream, screenTrack, dc;
  let makingOffer = false;
  let ignoreOffer = false;
  let isUnloading = false;

  pc.onicecandidate = ({candidate}) => { if (candidate) wsSend({ type:'ice', room, payload: candidate }); };
  pc.ontrack = ({streams}) => {
    if (!els.remote.srcObject) els.remote.srcObject = streams[0];
    try { els.remote.play(); } catch {}
    maybeShowUnmute();
    setBadge('–ó‚Äô—î–¥–Ω–∞–Ω–æ','ok');
  };
  pc.onconnectionstatechange = () => {
    const st = pc.connectionState;
    setBadge('–°—Ç–∞—Ç—É—Å: ' + st, st==='connected'?'ok':(st==='failed'?'danger':'muted'));
    if (st === 'connected') {
      els.start.textContent = '–ó‚Äô—î–¥–Ω–∞–Ω–æ'; els.start.disabled = true; els.start.classList.add('active');
    }
    if (st === 'failed') {
      logChat('–ó‚Äô—î–¥–Ω–∞–Ω–Ω—è –≤—Ç—Ä–∞—á–µ–Ω–æ. –ü—Ä–æ–±—É—î–º–æ –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏‚Ä¶','sys');
      restartIce();
    }
  };
  pc.ondatachannel = (e) => { dc = e.channel; bindDataChannel(); };
  pc.oniceconnectionstatechange = () => { logChat('ICE: ' + pc.iceConnectionState, 'sys'); };
  pc.onsignalingstatechange    = () => { logChat('Signaling: ' + pc.signalingState, 'sys'); };

  async function restartIce(){
    try{
      const offer = await pc.createOffer({ iceRestart: true });
      await pc.setLocalDescription(offer);
      wsSend({ type:'offer', room, payload: pc.localDescription });
    }catch(e){ console.warn('ICE restart failed', e); }
  }

  /* ========= –î–µ–≤–∞–π—Å–∏ ========= */
  async function startLocal(constraints){
    if (localStream) return localStream;
    const base = constraints || {
      audio: { echoCancellation:true, noiseSuppression:true, autoGainControl:true },
      video: { width: {ideal:1280}, height:{ideal:720}, frameRate:{ideal:30} }
    };
    try {
      localStream = await navigator.mediaDevices.getUserMedia(base);
    } catch (err) {
      if (err && (err.name === 'NotReadableError' || err.name === 'NotAllowedError' || err.name === 'NotFoundError')) {
        logChat('–ö–∞–º–µ—Ä–∞/–º—ñ–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ. –°–ø—Ä–æ–±–∞ –ª–∏—à–µ –∑ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–æ–º‚Ä¶', 'sys');
        if (els.hint) els.hint.textContent = '–ö–∞–º–µ—Ä–∞ –∑–∞–π–Ω—è—Ç–∞ –∞–±–æ –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–∞. –í–∏–∫–æ—Ä–∏—Å—Ç–∞—î–º–æ –ª–∏—à–µ –º—ñ–∫—Ä–æ—Ñ–æ–Ω.';
        localStream = await navigator.mediaDevices.getUserMedia({audio:true, video:false});
      } else {
        logChat('–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤: ' + (err.message||err.name), 'sys');
        throw err;
      }
    }
    const a = localStream.getAudioTracks()[0] || null;
    const v = localStream.getVideoTracks()[0] || null;
    if (a) await txAudio.sender.replaceTrack(a);
    if (v) await txVideo.sender.replaceTrack(v);

    els.local.srcObject = localStream;
    try { els.local.play(); } catch {}
    els.mic.disabled = !a;
    els.cam.disabled = !v;
    els.screen.disabled = false;
    return localStream;
  }

  /* ========= Perfect Negotiation ========= */
  async function createAndSendOffer(){
    try{
      makingOffer = true;
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      wsSend({ type:'offer', room, payload: pc.localDescription });
    } finally {
      makingOffer = false;
    }
  }

  /* ========= WebSocket (—Å–∏–≥–Ω–∞–ª—ñ–Ω–≥) + —Ä–µ–∫–æ–Ω–µ–∫—Ç ========= */
  let ws, wsReadyResolve;
  const wsReady = new Promise(r => wsReadyResolve = r);
  let reconnectTimer = null;

  function wsSend(obj){ if(ws && ws.readyState===1) ws.send(JSON.stringify(obj)); }

  function connectWS(){
    clearTimeout(reconnectTimer);
    ws = new WebSocket(SIGNAL_URL);

    ws.addEventListener('open', () => {
      wsReadyResolve?.();
      wsSend({ type:'join', room });
      if (els.hint) els.hint.textContent = '–ü—ñ–¥‚Äô—î–¥–Ω—É–π—Ç–µ—Å—å —ñ —á–µ–∫–∞–π—Ç–µ –Ω–∞ —Å–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫–∞.';
      logChat('–ü—ñ–¥‚Äô—î–¥–Ω–∞–Ω–æ –¥–æ —Å–∏–≥–Ω–∞–ª—ñ–Ω–≥—É', 'sys');
    });

    ws.addEventListener('message', async (e) => {
      const msg = JSON.parse(e.data);
      if (!msg || (msg.room && msg.room !== room)) return;

      if (msg.type === 'offer') {
        const offerDesc = new RTCSessionDescription(msg.payload);
        const collision = (makingOffer || pc.signalingState !== 'stable');
        ignoreOffer = !polite && collision;
        if (ignoreOffer) { logChat('–£–Ω–∏–∫–ª–∏ –∫–æ–ª—ñ–∑—ñ—ó offer/offer (—è ‚Äî —ñ–Ω—ñ—Ü—ñ–∞—Ç–æ—Ä)', 'sys'); return; }
        if (collision) {
          await Promise.all([
            pc.setLocalDescription({type:'rollback'}),
            pc.setRemoteDescription(offerDesc)
          ]);
        } else {
          await pc.setRemoteDescription(offerDesc);
        }
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        wsSend({ type:'answer', room, payload: pc.localDescription });
        return;
      }

      if (msg.type === 'answer') {
        if (!ignoreOffer) await pc.setRemoteDescription(new RTCSessionDescription(msg.payload));
        return;
      }

      if (msg.type === 'ice') {
        try { await pc.addIceCandidate(msg.payload); } catch {}
        return;
      }

      if (msg.type === 'bye') {
        els.remote.srcObject = null;
        logChat('–°–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫ –ø–æ–∫–∏–Ω—É–≤ –∫—ñ–º–Ω–∞—Ç—É', 'sys');
        return;
      }
    });

    ws.addEventListener('close', () => {
      logChat('–°–∏–≥–Ω–∞–ª—ñ–Ω–≥ –≤—ñ–¥–∫–ª—é—á–µ–Ω–æ', 'sys');
      if (!isUnloading) reconnectTimer = setTimeout(connectWS, 1500);
    });
  }
  connectWS();

  /* ========= DataChannel / —á–∞—Ç ========= */
  function bindDataChannel(){
    if (!dc) return;
    dc.onmessage = (e)=> logChat(e.data, 'peer');
    dc.onopen = ()=>{
      if (els.hint) els.hint.textContent = '–ß–∞—Ç –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ';
      els.msg.disabled = false;
      els.send.disabled = false;
      logChat('–ß–∞—Ç –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ', 'sys');
    };
    dc.onclose = ()=>{
      els.msg.disabled = true;
      els.send.disabled = true;
      logChat('–ß–∞—Ç –∑–∞–∫—Ä–∏—Ç–æ', 'sys');
    };
  }
  function sendChat(){
    const txt = els.msg.value.trim();
    if (!txt || !dc || dc.readyState!=='open') return;
    dc.send(txt);
    logChat(txt, 'me');
    els.msg.value = '';
  }
  els.send.onclick = sendChat;
  els.msg.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); sendChat(); }});

  /* ========= UI –ø–æ–¥—ñ—ó ========= */
  els.start.onclick = async () => {
    try{
      await wsReady;
      await startLocal();
      if (!dc) { dc = pc.createDataChannel('chat'); bindDataChannel(); }
      await createAndSendOffer();
      els.start.disabled = true;
      els.start.classList.add('active');
      setBadge('–û—á—ñ–∫—É—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å‚Ä¶','muted');
    }catch(err){
      setBadge('–ü–æ–º–∏–ª–∫–∞: ' + (err.message||err.name),'danger');
    }
  };

  els.mic.onclick = () => {
    const track = localStream && localStream.getAudioTracks()[0];
    if (track){
      track.enabled = !track.enabled;
      els.mic.textContent = track.enabled ? 'üéôÔ∏è –ú—ñ–∫—Ä–æ—Ñ–æ–Ω' : 'üîá –ú—ñ–∫—Ä–æ—Ñ–æ–Ω';
      els.mic.classList.toggle('active', !track.enabled);
    }
  };
  els.cam.onclick = () => {
    const track = localStream && localStream.getVideoTracks()[0];
    if (!track) return;
    track.enabled = !track.enabled;
    els.cam.textContent = track.enabled ? 'üì∑ –ö–∞–º–µ—Ä–∞' : 'üö´ –ö–∞–º–µ—Ä–∞';
    els.cam.classList.toggle('active', !track.enabled);
  };
  els.screen.onclick = async () => {
    try{
      const stream = await navigator.mediaDevices.getDisplayMedia({video:true});
      screenTrack = stream.getVideoTracks()[0];
      await txVideo.sender.replaceTrack(screenTrack);
      els.screen.classList.add('active');
      screenTrack.onended = async () => {
        const cam = localStream && localStream.getVideoTracks()[0];
        await txVideo.sender.replaceTrack(cam || null);
        els.screen.classList.remove('active');
      };
    }catch{}
  };

  function enterFullscreen(el){
    if (!el) return;
    try {
      if (el.requestFullscreen) return el.requestFullscreen();
      if (el.webkitEnterFullscreen) return el.webkitEnterFullscreen();
      if (el.webkitRequestFullscreen) return el.webkitRequestFullscreen();
      if (el.msRequestFullscreen) return el.msRequestFullscreen();
    } catch {}
  }
  function exitFullscreen(){
    try{
      if (document.exitFullscreen) return document.exitFullscreen();
      if (document.webkitExitFullscreen) return document.webkitExitFullscreen();
    }catch{}
  }
  function toggleFS(el){
    if (!document.fullscreenElement && !(document.webkitFullscreenElement)) enterFullscreen(el);
    else exitFullscreen();
  }
  els.fullRemote.addEventListener('click', ()=> toggleFS(els.remote));
  els.fullLocal .addEventListener('click', ()=> toggleFS(els.local));
  [els.remote, els.local].forEach(v => v.addEventListener('dblclick', ()=> toggleFS(v)));

  function isMobile(){ return /iPhone|iPad|iPod|Android/i.test(navigator.userAgent); }
  if (isMobile()){
    els.remote.addEventListener('click', ()=> enterFullscreen(els.remote), { passive:true });
    els.local .addEventListener('click', ()=> enterFullscreen(els.local),  { passive:true });
  }

  function maybeShowUnmute(){
    if (!isMobile()) return;
    els.vwrap.classList.add('has-unmute');
  }
  els.unmute.addEventListener('click', ()=>{
    try { els.remote.muted = false; els.remote.play(); } catch {}
    els.vwrap.classList.remove('has-unmute');
  });

  if (qs.get('autostart') === '1') {
    wsReady.then(()=> els.start.click()).catch(()=>{});
  }

  window.addEventListener('beforeunload', () => {
    isUnloading = true;
    try { wsSend({ type:'bye', room }); } catch {}
    if (dc) dc.close();
    pc.getSenders().forEach(s => s.track && s.track.stop());
    pc.close();
    ws && ws.close();
  });
  </script>

  <!-- –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ Eruda (–º–æ–±—ñ–ª—å–Ω–∞ –∫–æ–Ω—Å–æ–ª—å) –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö –∞–±–æ –∑ ?debug=1 -->
  <script>
    (function(){
      const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
      const wantDebug = isMobile || /(?:\\?|&)debug(?:=1)?/i.test(location.search) || /on/i.test(localStorage.getItem('eruda'));
      if (!wantDebug) return;
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/eruda@3/eruda.min.js';
      s.onload = function(){
        eruda.init();
        try { eruda.position({ x: 12, y: 12 }); } catch {}
        console.log('[eruda] ready');
        localStorage.setItem('eruda', 'on'); // –∑–∞–ø–∞–º‚Äô—è—Ç–∞—Ç–∏
      };
      document.body.appendChild(s);
    })();
  </script>

  <script src="js/partials.js"></script>
</body>
</html>
