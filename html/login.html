<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Вхід — КОМА</title>
  <meta name="description" content="Вхід до кабінету консультанта КОМА." />
  <link rel="icon" href="../icon/favicon.ico" type="image/x-icon" />
  <meta name="theme-color" content="#0f5257" />
  <link rel="stylesheet" href="css/main.css">


  
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="logo">
        <img src="../icon/logo.png" alt="КОМА">
        <div>
          <strong>КОМА</strong><br>
          <span style="color:#6b7280;font-size:.9rem">Вхід для консультантів</span>
        </div>
      </div>

      <h1>Вхід</h1>
      <p class="muted">Увійдіть за корпоративною електронною поштою та паролем.</p>

      <div id="err" class="error"></div>
      <div id="ok" class="ok"></div>

      <form id="form" autocomplete="on" novalidate>
        <label for="email">Ел. пошта</label>
        <input class="input" id="email" name="email" type="email" placeholder="name@example.com" required autofocus autocomplete="email">

        <label for="password">Пароль</label>
        <div class="row">
          <input class="input" id="password" name="password" type="password" placeholder="Ваш пароль" required autocomplete="current-password">
          <button type="button" id="toggle" aria-label="Показати/сховати пароль" style="border:none;background:#eef2f7;border-radius:12px;padding:10px 12px;cursor:pointer">Показати</button>
        </div>

        <div class="row" style="margin-top:10px">
          <label style="display:flex;align-items:center;gap:8px;font-weight:500">
            <input type="checkbox" id="remember"> Запам’ятати мене (30 днів)
          </label>
          <a href="#" id="clearSession" title="Вийти всюди">Вийти</a>
        </div>

        <button class="btn" type="submit" id="submit" style="margin-top:14px">Увійти</button>
        <div class="hint">Проблеми зі входом? Напишіть на <a href="mailto:info@nacc.example">info@nacc.example</a></div>
      </form>
    </div>

    <div class="footer">
      © <span id="y"></span> КОМА • <a href="index.html">На головну</a>
    </div>
  </div>

<script>
  // Рік у футері
  // Мінімальна «сесія» в localStorage
  const SESSION_KEY = 'koma_session';
  function setSession(email, days){
    const exp = Date.now() + days*24*60*60*1000;
    localStorage.setItem(SESSION_KEY, JSON.stringify({email, exp}));
  }
  function clearSession(){
    localStorage.removeItem(SESSION_KEY);
    showOk('Сесію очищено.');
  }
  document.getElementById('clearSession').onclick = (e)=>{ e.preventDefault(); clearSession(); };

  // Показ/приховати пароль
  document.getElementById('toggle').onclick = ()=>{
    const p = document.getElementById('password');
    p.type = (p.type === 'password') ? 'text' : 'password';
    document.getElementById('toggle').textContent = (p.type === 'password') ? 'Показати' : 'Сховати';
  };

  // Повідомлення
  const errBox = document.getElementById('err');
  const okBox  = document.getElementById('ok');
  function showErr(t){ errBox.textContent = t; errBox.style.display='block'; okBox.style.display='none'; }
  function showOk(t){ okBox.textContent = t; okBox.style.display='block'; errBox.style.display='none'; }

  // Параметри редіректу після входу (можете змінити на admin.html)
  const redirectTarget = 'admin.html';

  // Крипто-хелпер: SHA-256 у hex через Web Crypto API
  async function sha256Hex(str){
    const enc = new TextEncoder().encode(str);
    const digest = await crypto.subtle.digest('SHA-256', enc);
    return [...new Uint8Array(digest)].map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  // Завантажити файл із користувачами (АБСОЛЮТНИЙ шлях від кореня сайту)
  let users = [];
  fetch('/js/users.json', { cache:'no-store' })
    .then(r => r.ok ? r.json() : Promise.reject(new Error('HTTP '+r.status)))
    .then(j => users = j)
    .catch((e)=> showErr('Помилка завантаження даних користувачів. Перевірте, що файл доступний за адресою /js/users.json. Деталі: '+e.message));

  // Обробка форми
  document.getElementById('form').addEventListener('submit', async (e)=>{
    e.preventDefault();
    errBox.style.display='none'; okBox.style.display='none';

    const email = (document.getElementById('email').value || '').trim().toLowerCase();
    const pass  = document.getElementById('password').value || '';
    const remember = document.getElementById('remember').checked;

    if(!email || !pass){ showErr('Введіть пошту та пароль.'); return; }

    const u = users.find(x => x.email.toLowerCase() === email);
    if(!u){ showErr('Користувача не знайдено або немає доступу.'); return; }

    // Перевірка: hash(salt + password)
    const calc = await sha256Hex(u.salt + pass);
    if(calc !== u.hash){
      showErr('Невірний пароль.');
      return;
    }

    // Успіх — створюємо «сесію» та редірект
    setSession(email, remember ? 30 : 1);
    showOk('Вхід виконано. Перехід…');
    setTimeout(()=>{ location.href = redirectTarget; }, 400);
  });
</script>
  <script src="js/partials.js"></script>
</body>
</html>
