<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Вхід — КОМА</title>
  <meta name="description" content="Вхід до кабінету консультанта КОМА." />
  <link rel="icon" href="icon/favicon.ico" type="image/x-icon" />
  <meta name="theme-color" content="#0f5257" />
  <link rel="stylesheet" href="css/main.css">
</head>
<body>
  <div data-include="partials/header.html"></div>

  <div class="wrap">
    <div class="card">
      <div class="logo">
        <img src="icon/logo.png" alt="КОМА">
        <div>
          <strong>КОМА</strong><br>
          <span style="color:#6b7280;font-size:.9rem">Вхід для консультантів</span>
        </div>
      </div>

      <h1>Вхід</h1>
      <p class="muted">Увійдіть за корпоративною електронною поштою та паролем.</p>

      <div id="err" class="error"></div>
      <div id="ok" class="ok"></div>

      <form id="form" autocomplete="on" novalidate>
        <label for="email">Ел. пошта</label>
        <input class="input" id="email" name="email" type="email" placeholder="name@example.com" required autofocus autocomplete="username">

        <label for="password">Пароль</label>
        <div class="row">
          <input class="input" id="password" name="password" type="password" placeholder="Ваш пароль" required autocomplete="current-password">
          <button type="button" id="toggle" aria-label="Показати/сховати пароль" style="border:none;background:#eef2f7;border-radius:12px;padding:10px 12px;cursor:pointer">Показати</button>
        </div>

        <div class="row" style="margin-top:10px">
          <label style="display:flex;align-items:center;gap:8px;font-weight:500">
            <input type="checkbox" id="remember"> Запам’ятати мене (30 днів)
          </label>
          <a href="#" id="clearSession" title="Вийти всюди">Вийти</a>
        </div>

        <button class="btn" type="submit" id="submit" style="margin-top:14px">Увійти</button>
        <div class="hint">Проблеми зі входом? Напишіть на <a href="mailto:info@nacc.example">info@nacc.example</a></div>
      </form>
    </div>

    <div data-include="partials/footer.html"></div>
  </div>

  <!-- Гарда та підвантаження partials -->
  <script src="js/guard.js"></script>
  <script type="module" src="js/partials.js"></script>

  <script>
    // ===== helpers =====
    const SESSION_KEY = 'koma_session';
    const errBox = document.getElementById('err');
    const okBox  = document.getElementById('ok');

    function basePath(){ return location.pathname.replace(/[^/]+$/,''); }
    function showErr(t){ errBox.textContent = t; errBox.style.display='block'; okBox.style.display='none'; }
    function showOk(t){  okBox.textContent  = t; okBox.style.display='block';  errBox.style.display='none'; }

    function setSession(email, days){
      const exp = Date.now() + days*24*60*60*1000;
      localStorage.setItem(SESSION_KEY, JSON.stringify({email, exp}));
    }
    function clearSession(){
      localStorage.removeItem(SESSION_KEY);
      showOk('Сесію очищено.');
      // оновити шапку, якщо вже підвантажена
      if (window.guard?.applyAuthUI) window.guard.applyAuthUI({ desktop:'#authBtn', mobile:'#authBtnMobile' });
    }
    document.getElementById('clearSession').onclick = (e)=>{ e.preventDefault(); clearSession(); };

    // Показ/приховати пароль
    document.getElementById('toggle').onclick = ()=>{
      const p = document.getElementById('password');
      p.type = (p.type === 'password') ? 'text' : 'password';
      document.getElementById('toggle').textContent = (p.type === 'password') ? 'Показати' : 'Сховати';
    };

    // SHA-256 hex
    async function sha256Hex(str){
      const enc = new TextEncoder().encode(str);
      const digest = await crypto.subtle.digest('SHA-256', enc);
      return [...new Uint8Array(digest)].map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    // ===== users.json loader =====
    let users = null;
    let usersLoaded = (async () => {
      try{
        // users.json ЛЕЖИТЬ ПОРУЧ із login.html -> /html/users.json
        const res = await fetch(`${basePath()}users.json`, { cache:'no-store' });
        if(!res.ok) throw new Error('HTTP '+res.status);
        users = await res.json();
      }catch(e){
        showErr('Помилка завантаження users.json. Переконайтесь, що файл розміщено поруч із login.html. Деталі: ' + e.message);
        users = [];
      }
    })();

    // ===== submit =====
    document.getElementById('form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      errBox.style.display='none'; okBox.style.display='none';

      // Якщо users.json ще підвантажується — дочекаймося
      if (users === null) await usersLoaded;

      const email = (document.getElementById('email').value || '').trim().toLowerCase();
      const pass  = document.getElementById('password').value || '';
      const remember = document.getElementById('remember').checked;

      if(!email || !pass){ showErr('Введіть пошту та пароль.'); return; }

      const u = (users || []).find(x => String(x.email).toLowerCase() === email);
      if(!u){ showErr('Користувача не знайдено або немає доступу.'); return; }

      // Перевірка: hash(salt + password)
      let calc;
      try{
        calc = await sha256Hex(String(u.salt) + pass);
      }catch(e){
        showErr('Ваш браузер не підтримує Web Crypto API.');
        return;
      }
      if(calc !== String(u.hash)){
        showErr('Невірний пароль.');
        return;
      }

      // Додаткова перевірка доступу за guard.js (allowlist)
      if(!window.guard?.hasAccess(email)){
        showErr('Немає доступу до кабінету.');
        return;
      }

      // Успіх — створюємо «сесію» та редірект
      setSession(email, remember ? 30 : 1);
      showOk('Вхід виконано. Перехід…');
      setTimeout(()=>{ location.replace(`${basePath()}admin.html`); }, 400);
    });
  </script>
</body>
</html>
