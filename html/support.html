<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–°–ª—É–∂–±–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ ‚Äî –ö–û–ú–ê</title>
  <meta name="description" content="–ù–∞–ø–∏—à—ñ—Ç—å —É —Å–ª—É–∂–±—É –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ ¬´–ö–û–ú–ê¬ª. –ú–∏ –≤—ñ–¥–ø–æ–≤—ñ–º–æ —è–∫–Ω–∞–π—à–≤–∏–¥—à–µ." />
  <link rel="icon" href="icon/favicon.ico" type="image/x-icon" />
  <meta name="theme-color" content="#0f5257" />
  <link rel="stylesheet" href="css/main.css" />
  <link rel="stylesheet" href="css/zapis.css" />
  <style>
    .support-wrap{max-width:980px;margin:24px auto;padding:0 20px}
    .support-form{padding:22px}
    textarea.input{min-height:140px;resize:vertical}
    .accordion{border:1px solid var(--border);border-radius:12px;background:#fff}
    .accordion summary{cursor:pointer;list-style:none;padding:12px 14px;font-weight:700}
    .accordion summary::-webkit-details-marker{display:none}
    .acc-body{padding:0 14px 14px}
    .consultants{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
    @media (max-width:800px){.consultants{grid-template-columns:1fr 1fr}}
    @media (max-width:520px){.consultants{grid-template-columns:1fr}}
    .c-item{display:flex;align-items:center;gap:10px;border:1px solid var(--border);border-radius:10px;padding:10px}
    .c-item img{width:40px;height:40px;border-radius:10px;object-fit:cover;background:#eef2f7}
    .c-item .meta{font-size:.86rem;color:#6b7280}
    .radio{accent-color:var(--brand)}
    .hint-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .mutetiny{color:#6b7280;font-size:.9rem}
    .chat-wrap{margin-top:16px}
    .chat-head .tools{display:flex;gap:8px;align-items:center}
    .dot{display:inline-block;min-width:10px;height:10px;border-radius:999px;background:#10b981}
    .status-badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);padding:4px 8px;border-radius:999px;background:#fff;font-size:.8rem}
    /* –ª–æ–∫–∞–ª—å–Ω–∏–π –∂—É—Ä–Ω–∞–ª */
    #sup_log .event{border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff;cursor:pointer}
    #sup_log .event:hover{box-shadow:var(--shadow-sm)}
    #sup_log .small{color:#6b7280;font-size:.9rem}
  </style>
</head>
<body>
  <div data-include="partials/header.html"></div>

  <main class="section">
    <div class="support-wrap">
      <div class="card support-form">
        <h1 style="margin:0 0 10px">–°–ª—É–∂–±–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏</h1>
        <p class="lead">–û–ø–∏—à—ñ—Ç—å –ø—Ä–æ–±–ª–µ–º—É —á–∏ –∑–∞–ø–∏—Ç. –ú–∏ –≤—ñ–¥–ø–æ–≤—ñ–º–æ –Ω–∞ –≤–∫–∞–∑–∞–Ω—É –≤–∞–º–∏ –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω—É –ø–æ—à—Ç—É.</p>

        <div id="sup_err" class="error" role="alert" style="display:none;margin-top:8px"></div>
        <div id="sup_ok" class="ok" role="status" style="display:none;margin-top:8px"></div>

        <form id="supportForm" novalidate>
          <div class="grid grid-2">
            <div>
              <label>–í–∞—à–µ —ñ–º‚Äô—è</label>
              <input id="sup_name" class="input" type="text" placeholder="–Ü–º‚Äô—è —Ç–∞ –ø—Ä—ñ–∑–≤–∏—â–µ" required>
            </div>
            <div>
              <label>–ï–ª. –ø–æ—à—Ç–∞</label>
              <input id="sup_email" class="input" type="email" placeholder="you@example.com" required>
            </div>

            <div>
              <label>–¢–µ–º–∞</label>
              <select id="sup_topic" class="input">
                <option value="–¢–µ—Ö–Ω—ñ—á–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞">–¢–µ—Ö–Ω—ñ—á–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞</option>
                <option value="–ü–∏—Ç–∞–Ω–Ω—è –ø–æ –∑–∞–ø–∏—Å—É">–ü–∏—Ç–∞–Ω–Ω—è –ø–æ –∑–∞–ø–∏—Å—É</option>
                <option value="–û–ø–ª–∞—Ç–∞">–û–ø–ª–∞—Ç–∞</option>
                <option value="–ó–∞–ø–∏—Ç —â–æ–¥–æ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ–π">–ó–∞–ø–∏—Ç —â–æ–¥–æ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ–π</option>
                <option value="–ü–æ–±–∞–∂–∞–Ω–Ω—è / —ñ–¥–µ—è">–ü–æ–±–∞–∂–∞–Ω–Ω—è / —ñ–¥–µ—è</option>
                <option value="–Ü–Ω—à–µ">–Ü–Ω—à–µ</option>
              </select>
            </div>

            <div>
              <label>–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç</label>
              <select id="sup_priority" class="input">
                <option value="–ó–≤–∏—á–∞–π–Ω–∏–π">–ó–≤–∏—á–∞–π–Ω–∏–π</option>
                <option value="–í–∏—Å–æ–∫–∏–π">–í–∏—Å–æ–∫–∏–π</option>
                <option value="–¢–µ—Ä–º—ñ–Ω–æ–≤–∏–π">–¢–µ—Ä–º—ñ–Ω–æ–≤–∏–π</option>
              </select>
            </div>
          </div>

          <!-- –ó–≤–µ—Ä–Ω—É—Ç–∏—Å—å –¥–æ... -->
          <div style="margin-top:12px">
            <label>–ó–≤–µ—Ä–Ω—É—Ç–∏—Å—å –¥–æ‚Ä¶</label>
            <div class="accordion">
              <details id="acc" open>
                <summary>–í–∏–±—ñ—Ä –æ—Ç—Ä–∏–º—É–≤–∞—á–∞</summary>
                <div class="acc-body">
                  <div class="hint-row" style="margin-bottom:8px">
                    <label class="c-item" style="border-style:dashed">
                      <input class="radio" type="radio" name="target" value="support" checked>
                      <img src="icon/logo.png" alt="">
                      <div>
                        <div><strong>–°–ª—É–∂–±–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏</strong> <span class="meta">‚Äî –æ–ø—Ü—ñ—è –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º</span></div>
                        <div class="mutetiny">–Ø–∫—â–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞ –Ω–µ –≤–∏–±—Ä–∞–Ω–æ ‚Äî –∑–≤–µ—Ä–Ω–µ–Ω–Ω—è –ø—ñ–¥–µ —Å—é–¥–∏ —ñ —Å—Ç–∞–Ω–µ –≤–∏–¥–∏–º–∏–º —É—Å—ñ–º –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞–º.</div>
                      </div>
                    </label>
                  </div>

                  <div class="consultants">
                    <!-- 6 –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç—ñ–≤ -->
                    <label class="c-item">
                      <input class="radio" type="radio" name="target" value="oksanakokoten@gmail.com">
                      <img src="icon/consultants/oksana.jpg" alt="">
                      <div>
                        <div><strong>–û–∫—Å–∞–Ω–∞ –ö–æ–∫–æ—Ç–µ–Ω—å</strong></div>
                        <div class="meta">–ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç-–ø—Å–∏—Ö–æ–ª–æ–≥</div>
                      </div>
                    </label>

                    <label class="c-item">
                      <input class="radio" type="radio" name="target" value="sergiyoyovych@gmail.com">
                      <img src="icon/consultants/sergi.jpg" alt="">
                      <div>
                        <div><strong>–°–µ—Ä–≥—ñ–π –û–π–æ–≤–∏—á</strong></div>
                        <div class="meta">–î—É—à–µ–æ–ø—ñ–∫—É–Ω, –∫–∞–ø–µ–ª–∞–Ω</div>
                      </div>
                    </label>

                    <label class="c-item">
                      <input class="radio" type="radio" name="target" value="anastasiyoyovych@gmail.com">
                      <img src="icon/consultants/nastya.jpg" alt="">
                      <div>
                        <div><strong>–ê–Ω–∞—Å—Ç–∞—Å—ñ—è –û–π–æ–≤–∏—á</strong></div>
                        <div class="meta">–ü—Å–∏—Ö–æ–ª–æ–≥, –ö–ü–¢</div>
                      </div>
                    </label>

                    <label class="c-item">
                      <input class="radio" type="radio" name="target" value="oleksandrtkachuk@gmail.com">
                      <img src="icon/consultants/sasha.jpg" alt="">
                      <div>
                        <div><strong>–û–ª–µ–∫—Å–∞–Ω–¥—Ä –¢–∫–∞—á—É–∫</strong></div>
                        <div class="meta">–î–∏—Ç—è—á–∏–π —Ç–∞ –ø—ñ–¥–ª—ñ—Ç–∫–æ–≤–∏–π –ø—Å–∏—Ö–æ–ª–æ–≥</div>
                      </div>
                    </label>

                    <label class="c-item">
                      <input class="radio" type="radio" name="target" value="tetianamakovska@gmail.com">
                      <img src="icon/consultants/tanya.jpg" alt="">
                      <div>
                        <div><strong>–¢–µ—Ç—è–Ω–∞ –ú–∞–∫–æ–≤—Å—å–∫–∞</strong></div>
                        <div class="meta">–°—ñ–º–µ–π–Ω–∏–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç</div>
                      </div>
                    </label>

                    <label class="c-item">
                      <input class="radio" type="radio" name="target" value="kristinakokoten@gmail.com">
                      <img src="icon/consultants/kris.jpg" alt="">
                      <div>
                        <div><strong>–•—Ä–∏—Å—Ç–∏–Ω–∞ –ö–æ–∫–æ—Ç–µ–Ω—å</strong></div>
                        <div class="meta">–ü—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç</div>
                      </div>
                    </label>
                  </div>
                </div>
              </details>
            </div>
            <div class="mutetiny" style="margin-top:6px">–Ø–∫—â–æ –≤–∏ –Ω—ñ—á–æ–≥–æ –Ω–µ –≤–∏–±—Ä–∞–ª–∏ ‚Äî –∑–≤–µ—Ä–Ω–µ–Ω–Ω—è –ø—ñ–¥–µ –≤ <b>–°–ª—É–∂–±—É –ø—ñ–¥—Ç—Ä–∏–º–∫–∏</b> —ñ –±—É–¥–µ –≤–∏–¥–∏–º–∏–º —É—Å—ñ–º –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞–º.</div>
          </div>

          <div class="col-span-2" style="margin-top:12px">
            <label>–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</label>
            <textarea id="sup_message" class="input" placeholder="–û–ø–∏—à—ñ—Ç—å —Å–∏—Ç—É–∞—Ü—ñ—é –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ‚Ä¶" required></textarea>
          </div>

          <div class="row" style="margin-top:12px">
            <button id="sup_send" class="btn" type="submit">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
            <button class="btn gray" type="reset">–û—á–∏—Å—Ç–∏—Ç–∏</button>
          </div>
        </form>
      </div>

      <!-- –ñ–∏–≤–∏–π —á–∞—Ç -->
      <div class="chat-wrap">
        <div class="card chat-box">
          <div class="chat-head" style="padding:12px;border-bottom:1px solid var(--border)">
            <div class="row" style="justify-content:space-between;align-items:center">
              <div class="status-badge" id="connBadge"><span class="dot" id="connDot"></span> <span id="connText">–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è‚Ä¶</span></div>
              <div class="tools">
                <span class="tag" id="threadTag" style="display:none"></span>
              </div>
            </div>
          </div>
          <div id="msgs" class="chat-msgs" aria-live="polite"></div>
          <div class="chat-input">
            <textarea id="chatInput" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è‚Ä¶" disabled></textarea>
            <button id="chatSend" class="btn" disabled>–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
          </div>
        </div>
      </div>

      <!-- –õ–æ–∫–∞–ª—å–Ω—ñ —ñ—Å—Ç–æ—Ä—ñ—ó -->
      <section style="margin-top:18px">
        <div class="card" style="padding:16px">
          <h3 style="margin:0 0 8px">–û—Å—Ç–∞–Ω–Ω—ñ –∑–≤–µ—Ä–Ω–µ–Ω–Ω—è (–ª–æ–∫–∞–ª—å–Ω–æ)</h3>
          <div id="sup_log" class="grid" style="grid-template-columns:1fr;gap:10px"></div>
        </div>
      </section>
    </div>
  </main>

  <div data-include="partials/footer.html"></div>

  <script src="js/guard.js"></script>
  <script type="module" src="js/partials.js"></script>
  <script src="js/config.js"></script>
  <script type="module" src="js/support-chat.js"></script>
  <script type="module">
    import { SupportChat } from './js/support-chat.js';

    const form    = document.getElementById('supportForm');
    const okBox   = document.getElementById('sup_ok');
    const errBox  = document.getElementById('sup_err');
    const logBox  = document.getElementById('sup_log');
    const msgsEl  = document.getElementById('msgs');
    const inpChat = document.getElementById('chatInput');
    const btnChat = document.getElementById('chatSend');
    const connDot = document.getElementById('connDot');
    const connTxt = document.getElementById('connText');
    const threadTag = document.getElementById('threadTag');

    const chat = new SupportChat({ role: 'user', onEvent: handleEvent });

    // –ü—Ä–µ—Ñ—ñ–ª –∑ guard
    (() => {
      const s = window.guard?.getSession?.();
      if (s?.email) {
        document.getElementById('sup_email').value = s.email;
        const nm = window.guard?.emailToName?.(s.email);
        if (nm) document.getElementById('sup_name').value = nm;
      } else {
        const g = window.guard?.getGuest?.();
        if (g?.name) document.getElementById('sup_name').value = g.name;
      }
    })();

    function setConn(state){
      if (state){ connDot.style.background = '#10b981'; connTxt.textContent = '–û–Ω–ª–∞–π–Ω'; }
      else { connDot.style.background = '#f59e0b'; connTxt.textContent = '–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è‚Ä¶'; }
    }
    function handleEvent(ev, payload){
      if (ev === 'status'){ setConn(payload.connected); return; }
      if (ev === 'chat'){ addMsg(payload); autoRead(payload); return; }
      if (ev === 'delivered' || ev === 'read'){ markTicks(payload); return; }
    }
    function addMsg(m){
      const div = document.createElement('div');
      const mine = (m.role === 'user');
      div.className = `msg ${mine ? 'me' : 'them'}`;
      div.dataset.mid = m.mid;
      const ts = new Date(m.ts || m.serverTs || Date.now()).toLocaleString('uk-UA');
      const who = mine ? '–í–∏' : (m.consultantName || '–ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç');
      div.innerHTML = `${escapeHtml(m.text)}<div class="meta">${who} ¬∑ ${ts}</div>`;
      msgsEl.appendChild(div);
      requestAnimationFrame(()=>{ msgsEl.scrollTop = msgsEl.scrollHeight + 9999; });
    }
    function markTicks(p){
      const node = msgsEl.querySelector(`[data-mid="${p.mid}"] .meta`);
      if (!node) return;
      const t = node.textContent;
      if (p.type==='delivered' && !/‚úì/.test(t)) node.textContent = t + ' ¬∑ ‚úì –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ';
      if (p.type==='read' && !/‚úì‚úì/.test(t)) node.textContent = t.replace('‚úì –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ','') + ' ¬∑ ‚úì‚úì –ø—Ä–æ—á–∏—Ç–∞–Ω–æ';
    }
    function autoRead(m){
      if (m.role !== 'user' && currentThread){
        chat.markRead({ threadId: currentThread.id, mid: m.mid, room: `support:thread:${currentThread.id}` });
      }
    }
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch])); }

    // ===== –õ–æ–∫–∞–ª—å–Ω–∏–π –∂—É—Ä–Ω–∞–ª
    function getLocalList(){ try { return JSON.parse(localStorage.getItem('koma_support_log')||'[]'); } catch { return []; } }
    function setLocalList(list){ try { localStorage.setItem('koma_support_log', JSON.stringify(list.slice(0,20))); } catch {} }
    function renderLocal(){
      try{
        const all = getLocalList();
        logBox.innerHTML = all.length ? all.map(x => (
          `<div class="event" data-thread="${escapeHtml(x.threadId||'')}">
            <strong>${escapeHtml(x.name)}</strong> &lt;${escapeHtml(x.email)}&gt; ‚Äî <em>${escapeHtml(x.topic)}</em>
            <div class="small">${new Date(x.ts).toLocaleString('uk-UA')}</div>
            <div>${escapeHtml(x.message)}</div>
          </div>`
        )).join('') : '<div class="muted">–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤.</div>';
      }catch{
        logBox.innerHTML = '<div class="muted">–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤.</div>';
      }
    }
    function addLocalEntry(entry){
      const list = getLocalList();
      const rest = entry.threadId ? list.filter(x => x.threadId !== entry.threadId) : list;
      setLocalList([entry, ...rest]);
      renderLocal();
    }
    renderLocal();

    logBox.addEventListener('click', (e)=>{
      const card = e.target.closest('.event');
      if (!card) return;
      const tid = card.getAttribute('data-thread');
      if (tid) openThread(tid);
    });

    // ===== –ß–∞—Ç
    let currentThread = null;
    function buildThreadId(payload, target){
      const u = (payload.email || 'user').toLowerCase();
      const c = (target || 'support').toLowerCase();
      const t = (payload.topic || 'topic').toLowerCase().slice(0,24);
      return `${u}__${c}__${t}`;
    }

    function openThread(threadId){
      currentThread = { id: threadId };
      chat.joinThread(threadId);
      threadTag.textContent = `–¢—Ä–µ–¥: ${threadId}`;
      threadTag.style.display='inline-flex';
      inpChat.disabled=false; btnChat.disabled=false;
      const list = chat.getThread(threadId);
      msgsEl.innerHTML='';
      list.forEach(m => addMsg(m));
      list.filter(m=>m.role!=='user').forEach(m=>{
        chat.markRead({ threadId, mid:m.mid, room:`support:thread:${threadId}` });
      });
      requestAnimationFrame(()=>{ msgsEl.scrollTop = msgsEl.scrollHeight + 9999; });
    }

    // –ù–∞–¥—Å–∏–ª–∞–Ω–Ω—è —Ñ–æ—Ä–º–∏
    form.addEventListener('submit', (e)=>{
      e.preventDefault();
      errBox.style.display='none'; okBox.style.display='none';

      const payload = {
        name: document.getElementById('sup_name').value.trim(),
        email: document.getElementById('sup_email').value.trim(),
        topic: document.getElementById('sup_topic').value,
        priority: document.getElementById('sup_priority').value,
        message: document.getElementById('sup_message').value.trim()
      };
      if(!payload.name || !payload.email || !payload.message){
        errBox.textContent = '–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –æ–±–æ–≤ º—è–∑–∫–æ–≤—ñ –ø–æ–ª—è.'; errBox.style.display='block'; return;
      }

      const target = (document.querySelector('input[name="target"]:checked')?.value || 'support');

      const threadId = buildThreadId(payload, target);
      currentThread = { id: threadId, targetConsultant: (target==='support' ? '' : target) };
      chat.joinThread(threadId);

      threadTag.textContent = `–¢—Ä–µ–¥: ${threadId}`;
      threadTag.style.display='inline-flex';
      inpChat.disabled=false; btnChat.disabled=false;

      const roomThread = `support:thread:${threadId}`;
      const meta = {
        userName: payload.name,
        userEmail: payload.email,
        topic: payload.topic,
        prio: payload.priority,
        targetConsultant: (target==='support' ? '' : target)
      };

      // üîî –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –¥–ª—è –∞–¥–º—ñ–Ω—ñ–≤ ‚Äî –ù–ï –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–æ
      chat.sendChat({
        room: 'support:all',
        threadId,
        text: payload.message,
        from: payload.email,
        to: meta.targetConsultant || '',
        extras: meta,
        noStore: true
      });
      if (meta.targetConsultant){
        chat.sendChat({
          room: `support:consultant:${meta.targetConsultant}`,
          threadId,
          text: payload.message,
          from: payload.email,
          to: meta.targetConsultant,
          extras: meta,
          noStore: true
        });
      }

      // ‚úÖ –†–µ–∞–ª—å–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ‚Äî —Ç—ñ–ª—å–∫–∏ —É —Å–≤—ñ–π —Ç—Ä–µ–¥ (–≤—ñ–¥–º–∞–ª—é—î—Ç—å—Å—è –æ–¥–∏–Ω —Ä–∞–∑)
      chat.sendChat({
        room: roomThread,
        threadId,
        text: payload.message,
        from: payload.email,
        to: meta.targetConsultant || '',
        extras: meta
      });

      okBox.textContent = '–ó–≤–µ—Ä–Ω–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ. –û—á—ñ–∫—É–π—Ç–µ –≤—ñ–¥–ø–æ–≤—ñ–¥—å —É —Ü—å–æ–º—É —á–∞—Ç—ñ —Ç–∞/–∞–±–æ –Ω–∞ –ø–æ—à—Ç—É.';
      okBox.style.display='block';

      addLocalEntry({ threadId, name: payload.name, email: payload.email, topic: payload.topic, message: payload.message, ts: Date.now() });
      document.getElementById('sup_message').value = '';
    });

    // –ù–∞–¥—Å–∏–ª–∞–Ω–Ω—è –Ω–∞—Å—Ç—É–ø–Ω–∏—Ö —Ä–µ–ø–ª—ñ–∫
    btnChat.addEventListener('click', sendChatMsg);
    inpChat.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' && !–µ.shiftKey){ e.preventDefault(); sendChatMsg(); }
    });
    function sendChatMsg(){
      if (!currentThread) return;
      const text = inpChat.value.trim();
      if (!text) return;
      const email = document.getElementById('sup_email').value.trim();
      chat.sendChat({
        room: `support:thread:${currentThread.id}`,
        threadId: currentThread.id,
        text,
        from: email,
        to: currentThread.targetConsultant || ''
      });
      inpChat.value = '';
    }
  </script>
</body>
</html>
