<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Служба підтримки — КОМА</title>
  <meta name="description" content="Напишіть у службу підтримки «КОМА». Ми відповімо якнайшвидше." />
  <link rel="icon" href="icon/favicon.ico" type="image/x-icon" />
  <meta name="theme-color" content="#0f5257" />
  <link rel="stylesheet" href="css/main.css" />
  <link rel="stylesheet" href="css/zapis.css" />
  <style>
    .support-wrap{max-width:980px;margin:24px auto;padding:0 20px}
    .support-form{padding:22px}
    textarea.input{min-height:140px;resize:vertical}
    .accordion{border:1px solid var(--border);border-radius:12px;background:#fff}
    .accordion summary{cursor:pointer;list-style:none;padding:12px 14px;font-weight:700}
    .accordion summary::-webkit-details-marker{display:none}
    .acc-body{padding:0 14px 14px}
    .consultants{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
    @media (max-width:800px){.consultants{grid-template-columns:1fr 1fr}}
    @media (max-width:520px){.consultants{grid-template-columns:1fr}}
    .c-item{display:flex;align-items:center;gap:10px;border:1px solid var(--border);border-radius:10px;padding:10px}
    .c-item img{width:40px;height:40px;border-radius:10px;object-fit:cover;background:#eef2f7}
    .c-item .meta{font-size:.86rem;color:#6b7280}
    .radio{accent-color:var(--brand)}
    .hint-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .mutetiny{color:#6b7280;font-size:.9rem}
    .chat-wrap{margin-top:16px}
    .chat-head .tools{display:flex;gap:8px;align-items:center}
    .dot{display:inline-block;min-width:10px;height:10px;border-radius:999px;background:#10b981}
    .status-badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);padding:4px 8px;border-radius:999px;background:#fff;font-size:.8rem}
    /* локальний журнал */
    #sup_log .event{border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff;cursor:pointer}
    #sup_log .event:hover{box-shadow:var(--shadow-sm)}
    #sup_log .small{color:#6b7280;font-size:.9rem}
  </style>
</head>
<body>
  <div data-include="partials/header.html"></div>

  <main class="section">
    <div class="support-wrap">
      <div class="card support-form">
        <h1 style="margin:0 0 10px">Служба підтримки</h1>
        <p class="lead">Опишіть проблему чи запит. Ми відповімо на вказану вами електронну пошту.</p>

        <div id="sup_err" class="error" role="alert" style="display:none;margin-top:8px"></div>
        <div id="sup_ok" class="ok" role="status" style="display:none;margin-top:8px"></div>

        <form id="supportForm" novalidate>
          <div class="grid grid-2">
            <div>
              <label>Ваше ім’я</label>
              <input id="sup_name" class="input" type="text" placeholder="Ім’я та прізвище" required>
            </div>
            <div>
              <label>Ел. пошта</label>
              <input id="sup_email" class="input" type="email" placeholder="you@example.com" required>
            </div>

            <div>
              <label>Тема</label>
              <select id="sup_topic" class="input">
                <option value="Технічна проблема">Технічна проблема</option>
                <option value="Питання по запису">Питання по запису</option>
                <option value="Оплата">Оплата</option>
                <option value="Запит щодо консультацій">Запит щодо консультацій</option>
                <option value="Побажання / ідея">Побажання / ідея</option>
                <option value="Інше">Інше</option>
              </select>
            </div>

            <div>
              <label>Пріоритет</label>
              <select id="sup_priority" class="input">
                <option value="Звичайний">Звичайний</option>
                <option value="Високий">Високий</option>
                <option value="Терміновий">Терміновий</option>
              </select>
            </div>
          </div>

          <!-- Звернутись до... -->
          <div style="margin-top:12px">
            <label>Звернутись до…</label>
            <div class="accordion">
              <details id="acc" open>
                <summary>Вибір отримувача</summary>
                <div class="acc-body">
                  <div class="hint-row" style="margin-bottom:8px">
                    <label class="c-item" style="border-style:dashed">
                      <input class="radio" type="radio" name="target" value="support" checked>
                      <img src="icon/logo.png" alt="">
                      <div>
                        <div><strong>Служба підтримки</strong> <span class="meta">— опція за замовчуванням</span></div>
                        <div class="mutetiny">Якщо конкретного консультанта не вибрано — звернення піде сюди і стане видимим усім консультантам.</div>
                      </div>
                    </label>
                  </div>

                  <div class="consultants">
                    <!-- 6 консультантів -->
                    <label class="c-item">
                      <input class="radio" type="radio" name="target" value="oksanakokoten@gmail.com">
                      <img src="icon/consultants/oksana.jpg" alt="">
                      <div>
                        <div><strong>Оксана Кокотень</strong></div>
                        <div class="meta">Консультант-психолог</div>
                      </div>
                    </label>

                    <label class="c-item">
                      <input class="radio" type="radio" name="target" value="sergiyoyovych@gmail.com">
                      <img src="icon/consultants/sergi.jpg" alt="">
                      <div>
                        <div><strong>Сергій Ойович</strong></div>
                        <div class="meta">Душеопікун, капелан</div>
                      </div>
                    </label>

                    <label class="c-item">
                      <input class="radio" type="radio" name="target" value="anastasiyoyovych@gmail.com">
                      <img src="icon/consultants/nastya.jpg" alt="">
                      <div>
                        <div><strong>Анастасія Ойович</strong></div>
                        <div class="meta">Психолог, КПТ</div>
                      </div>
                    </label>

                    <label class="c-item">
                      <input class="radio" type="radio" name="target" value="oleksandrtkachuk@gmail.com">
                      <img src="icon/consultants/sasha.jpg" alt="">
                      <div>
                        <div><strong>Олександр Ткачук</strong></div>
                        <div class="meta">Дитячий та підлітковий психолог</div>
                      </div>
                    </label>

                    <label class="c-item">
                      <input class="radio" type="radio" name="target" value="tetianamakovska@gmail.com">
                      <img src="icon/consultants/tanya.jpg" alt="">
                      <div>
                        <div><strong>Тетяна Маковська</strong></div>
                        <div class="meta">Сімейний консультант</div>
                      </div>
                    </label>

                    <label class="c-item">
                      <input class="radio" type="radio" name="target" value="kristinakokoten@gmail.com">
                      <img src="icon/consultants/kris.jpg" alt="">
                      <div>
                        <div><strong>Христина Кокотень</strong></div>
                        <div class="meta">Психотерапевт</div>
                      </div>
                    </label>
                  </div>
                </div>
              </details>
            </div>
            <div class="mutetiny" style="margin-top:6px">Якщо ви нічого не вибрали — звернення піде в <b>Службу підтримки</b> і буде видимим усім консультантам.</div>
          </div>

          <div class="col-span-2" style="margin-top:12px">
            <label>Повідомлення</label>
            <textarea id="sup_message" class="input" placeholder="Опишіть ситуацію максимально конкретно…" required></textarea>
          </div>

          <div class="row" style="margin-top:12px">
            <button id="sup_send" class="btn" type="submit">Надіслати</button>
            <button class="btn gray" type="reset">Очистити</button>
          </div>
        </form>
      </div>

      <!-- Живий чат -->
      <div class="chat-wrap">
        <div class="card chat-box">
          <div class="chat-head" style="padding:12px;border-bottom:1px solid var(--border)">
            <div class="row" style="justify-content:space-between;align-items:center">
              <div class="status-badge" id="connBadge"><span class="dot" id="connDot"></span> <span id="connText">Підключення…</span></div>
              <div class="tools">
                <span class="tag" id="threadTag" style="display:none"></span>
              </div>
            </div>
          </div>
          <div id="msgs" class="chat-msgs" aria-live="polite"></div>
          <div class="chat-input">
            <textarea id="chatInput" placeholder="Напишіть повідомлення…" disabled></textarea>
            <button id="chatSend" class="btn" disabled>Надіслати</button>
          </div>
        </div>
      </div>

      <!-- Локальні історії -->
      <section style="margin-top:18px">
        <div class="card" style="padding:16px">
          <h3 style="margin:0 0 8px">Останні звернення (локально)</h3>
          <div id="sup_log" class="grid" style="grid-template-columns:1fr;gap:10px"></div>
        </div>
      </section>
    </div>
  </main>

  <div data-include="partials/footer.html"></div>

  <script src="js/guard.js"></script>
  <script type="module" src="js/partials.js"></script>
  <script src="js/config.js"></script>
  <script type="module" src="js/support-chat.js"></script>
  <script type="module">
    import { SupportChat } from './js/support-chat.js';

    const form    = document.getElementById('supportForm');
    const okBox   = document.getElementById('sup_ok');
    const errBox  = document.getElementById('sup_err');
    const logBox  = document.getElementById('sup_log');
    const msgsEl  = document.getElementById('msgs');
    const inpChat = document.getElementById('chatInput');
    const btnChat = document.getElementById('chatSend');
    const connDot = document.getElementById('connDot');
    const connTxt = document.getElementById('connText');
    const threadTag = document.getElementById('threadTag');

    const chat = new SupportChat({ role: 'user', onEvent: handleEvent });

    // Префіл з guard
    (() => {
      const s = window.guard?.getSession?.();
      if (s?.email) {
        document.getElementById('sup_email').value = s.email;
        const nm = window.guard?.emailToName?.(s.email);
        if (nm) document.getElementById('sup_name').value = nm;
      } else {
        const g = window.guard?.getGuest?.();
        if (g?.name) document.getElementById('sup_name').value = g.name;
      }
    })();

    function setConn(state){
      if (state){ connDot.style.background = '#10b981'; connTxt.textContent = 'Онлайн'; }
      else { connDot.style.background = '#f59e0b'; connTxt.textContent = 'Підключення…'; }
    }
    function handleEvent(ev, payload){
      if (ev === 'status'){ setConn(payload.connected); return; }
      if (ev === 'chat'){ addMsg(payload); autoRead(payload); return; }
      if (ev === 'delivered' || ev === 'read'){ markTicks(payload); return; }
    }
    function addMsg(m){
      const div = document.createElement('div');
      const mine = (m.role === 'user');
      div.className = `msg ${mine ? 'me' : 'them'}`;
      div.dataset.mid = m.mid;
      const ts = new Date(m.ts || m.serverTs || Date.now()).toLocaleString('uk-UA');
      const who = mine ? 'Ви' : (m.consultantName || 'Консультант');
      div.innerHTML = `${escapeHtml(m.text)}<div class="meta">${who} · ${ts}</div>`;
      msgsEl.appendChild(div);
      requestAnimationFrame(()=>{ msgsEl.scrollTop = msgsEl.scrollHeight + 9999; });
    }
    function markTicks(p){
      const node = msgsEl.querySelector(`[data-mid="${p.mid}"] .meta`);
      if (!node) return;
      const t = node.textContent;
      if (p.type==='delivered' && !/✓/.test(t)) node.textContent = t + ' · ✓ доставлено';
      if (p.type==='read' && !/✓✓/.test(t)) node.textContent = t.replace('✓ доставлено','') + ' · ✓✓ прочитано';
    }
    function autoRead(m){
      if (m.role !== 'user' && currentThread){
        chat.markRead({ threadId: currentThread.id, mid: m.mid, room: `support:thread:${currentThread.id}` });
      }
    }
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch])); }

    // ===== Локальний журнал
    function getLocalList(){ try { return JSON.parse(localStorage.getItem('koma_support_log')||'[]'); } catch { return []; } }
    function setLocalList(list){ try { localStorage.setItem('koma_support_log', JSON.stringify(list.slice(0,20))); } catch {} }
    function renderLocal(){
      try{
        const all = getLocalList();
        logBox.innerHTML = all.length ? all.map(x => (
          `<div class="event" data-thread="${escapeHtml(x.threadId||'')}">
            <strong>${escapeHtml(x.name)}</strong> &lt;${escapeHtml(x.email)}&gt; — <em>${escapeHtml(x.topic)}</em>
            <div class="small">${new Date(x.ts).toLocaleString('uk-UA')}</div>
            <div>${escapeHtml(x.message)}</div>
          </div>`
        )).join('') : '<div class="muted">Поки що немає записів.</div>';
      }catch{
        logBox.innerHTML = '<div class="muted">Поки що немає записів.</div>';
      }
    }
    function addLocalEntry(entry){
      const list = getLocalList();
      const rest = entry.threadId ? list.filter(x => x.threadId !== entry.threadId) : list;
      setLocalList([entry, ...rest]);
      renderLocal();
    }
    renderLocal();

    logBox.addEventListener('click', (e)=>{
      const card = e.target.closest('.event');
      if (!card) return;
      const tid = card.getAttribute('data-thread');
      if (tid) openThread(tid);
    });

    // ===== Чат
    let currentThread = null;
    function buildThreadId(payload, target){
      const u = (payload.email || 'user').toLowerCase();
      const c = (target || 'support').toLowerCase();
      const t = (payload.topic || 'topic').toLowerCase().slice(0,24);
      return `${u}__${c}__${t}`;
    }

    function openThread(threadId){
      currentThread = { id: threadId };
      chat.joinThread(threadId);
      threadTag.textContent = `Тред: ${threadId}`;
      threadTag.style.display='inline-flex';
      inpChat.disabled=false; btnChat.disabled=false;
      const list = chat.getThread(threadId);
      msgsEl.innerHTML='';
      list.forEach(m => addMsg(m));
      list.filter(m=>m.role!=='user').forEach(m=>{
        chat.markRead({ threadId, mid:m.mid, room:`support:thread:${threadId}` });
      });
      requestAnimationFrame(()=>{ msgsEl.scrollTop = msgsEl.scrollHeight + 9999; });
    }

    // Надсилання форми
    form.addEventListener('submit', (e)=>{
      e.preventDefault();
      errBox.style.display='none'; okBox.style.display='none';

      const payload = {
        name: document.getElementById('sup_name').value.trim(),
        email: document.getElementById('sup_email').value.trim(),
        topic: document.getElementById('sup_topic').value,
        priority: document.getElementById('sup_priority').value,
        message: document.getElementById('sup_message').value.trim()
      };
      if(!payload.name || !payload.email || !payload.message){
        errBox.textContent = 'Заповніть обовʼязкові поля.'; errBox.style.display='block'; return;
      }

      const target = (document.querySelector('input[name="target"]:checked')?.value || 'support');

      const threadId = buildThreadId(payload, target);
      currentThread = { id: threadId, targetConsultant: (target==='support' ? '' : target) };
      chat.joinThread(threadId);

      threadTag.textContent = `Тред: ${threadId}`;
      threadTag.style.display='inline-flex';
      inpChat.disabled=false; btnChat.disabled=false;

      const roomThread = `support:thread:${threadId}`;
      const meta = {
        userName: payload.name,
        userEmail: payload.email,
        topic: payload.topic,
        prio: payload.priority,
        targetConsultant: (target==='support' ? '' : target)
      };

      // 🔔 Сповіщення для адмінів — НЕ зберігати локально
      chat.sendChat({
        room: 'support:all',
        threadId,
        text: payload.message,
        from: payload.email,
        to: meta.targetConsultant || '',
        extras: meta,
        noStore: true
      });
      if (meta.targetConsultant){
        chat.sendChat({
          room: `support:consultant:${meta.targetConsultant}`,
          threadId,
          text: payload.message,
          from: payload.email,
          to: meta.targetConsultant,
          extras: meta,
          noStore: true
        });
      }

      // ✅ Реальне повідомлення користувача — тільки у свій тред (відмалюється один раз)
      chat.sendChat({
        room: roomThread,
        threadId,
        text: payload.message,
        from: payload.email,
        to: meta.targetConsultant || '',
        extras: meta
      });

      okBox.textContent = 'Звернення надіслано. Очікуйте відповідь у цьому чаті та/або на пошту.';
      okBox.style.display='block';

      addLocalEntry({ threadId, name: payload.name, email: payload.email, topic: payload.topic, message: payload.message, ts: Date.now() });
      document.getElementById('sup_message').value = '';
    });

    // Надсилання наступних реплік
    btnChat.addEventListener('click', sendChatMsg);
    inpChat.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' && !е.shiftKey){ e.preventDefault(); sendChatMsg(); }
    });
    function sendChatMsg(){
      if (!currentThread) return;
      const text = inpChat.value.trim();
      if (!text) return;
      const email = document.getElementById('sup_email').value.trim();
      chat.sendChat({
        room: `support:thread:${currentThread.id}`,
        threadId: currentThread.id,
        text,
        from: email,
        to: currentThread.targetConsultant || ''
      });
      inpChat.value = '';
    }
  </script>
</body>
</html>
