<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Кабінет консультанта — КОМА</title>
  <link rel="icon" href="../icon/favicon.ico" />
  <meta name="theme-color" content="#0f5257" />
  <style>
    :root{
      --page-bg:#ffffff; --text:#111827; --muted:#4b5563; --brand:#0f5257;
      --border:#e5e7eb; --panel:#ffffff; --radius:16px;
      --shadow:0 10px 30px rgba(0,0,0,.08); --shadow-sm:0 6px 18px rgba(0,0,0,.06);
      --max:1100px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:#f7fafb;color:var(--text);
      font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .container{max-width:var(--max);margin:0 auto;padding:0 20px}
    header{background:linear-gradient(135deg,#0b2e33,#0f5257 60%,#6fc8b8);color:#fff}
    .nav{display:flex;align-items:center;justify-content:space-between;height:68px}
    .brand{display:flex;align-items:center;gap:12px;color:#fff;text-decoration:none}
    .brand img{height:40px;border-radius:8px}
    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.75rem 1.1rem;border-radius:999px;
      background:#0f5257;color:#fff;font-weight:700;border:1px solid transparent;box-shadow:var(--shadow-sm);cursor:pointer}
    .btn.ghost{background:#fff;color:#0f5257;border-color:#0f5257}
    .btn.gray{background:#eef2f7;color:#111;border-color:#e5e7eb}
    .section{padding:28px 0}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
    .grid{display:grid;gap:18px}
    .g-2{grid-template-columns:1fr 1fr}
    @media (max-width:900px){.g-2{grid-template-columns:1fr}}
    label{display:block;margin:.4rem 0 .25rem;font-weight:600}
    .input{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;background:#fff}
    .input:focus{outline:none;box-shadow:0 0 0 3px rgba(15,82,87,.18)}
    .muted{color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:#f8fafc;border-radius:999px;padding:8px 12px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .ok{color:#065f46}
  </style>
</head>
<body>
  <header>
    <div class="container nav">
      <a class="brand" href="index.html"><img src="../icon/logo.png" alt=""><strong>КОМА</strong></a>
      <div class="row">
        <a class="btn ghost" href="directory.html">Каталог консультантів</a>
        <a class="btn ghost" href="clients.html" title="Перегляд/ведення клієнтів">Клієнти</a>
        <button id="logout" class="btn gray">Вийти</button>
      </div>
    </div>
  </header>

  <section class="section">
    <div class="container grid g-2">
      <div class="card">
        <h2 style="margin:0 0 6px">Вітаємо у кабінеті</h2>
        <p class="muted" id="who">—</p>
        <div class="pill" style="margin-top:10px">Статус доступу: <span id="status" class="ok">дозволено</span></div>
        <p class="muted" style="margin-top:10px">Ця сторінка доступна лише авторизованим асистентам «КОМА».</p>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px">Згенерувати посилання на відеозустріч</h3>
        <div class="grid" style="grid-template-columns:1fr 1fr;gap:10px">
          <div>
            <label>Ім’я клієнта (для нотатки)</label>
            <input id="clientName" class="input" placeholder="Клієнт">
          </div>
          <div>
            <label>Ел. пошта клієнта (необов’язково)</label>
            <input id="clientEmail" class="input" type="email" placeholder="client@example.com">
          </div>
          <div>
            <label>Дата</label>
            <input id="date" class="input" type="date">
          </div>
          <div>
            <label>Час (Київ)</label>
            <input id="time" class="input" type="time">
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <button id="make" class="btn">Створити лінк</button>
          <button id="copy" class="btn gray" disabled>Скопіювати</button>
          <a id="open" class="btn ghost" href="#" target="_blank" rel="noopener" style="pointer-events:none;opacity:.6">Відкрити</a>
        </div>
        <p class="muted" id="out" style="margin-top:10px">—</p>
      </div>
    </div>
  </section>

  <footer class="section" style="padding:22px 0;border-top:1px solid var(--border)">
    <div class="container muted">© <span id="y"></span> КОМА</div>
  </footer>

  <script src="js/guard.js"></script>
  <script>
    // захист сторінки
    guard.protect(); // редіректить на login.html, якщо немає сесії або email не з allowlist

    // футер
    document.getElementById('y').textContent = new Date().getFullYear();

    // показ email/імені
    const me = guard.getSession();
    document.getElementById('who').textContent = `Користувач: ${me.email}`;
    const myName = guard.emailToName(me.email) || 'Консультант';

    // дефолтна дата/час (сьогодні + 1 день) — часова зона Києва
    const kyivNow = new Date(new Date().toLocaleString('en-CA', { timeZone: 'Europe/Kyiv' }));
    kyivNow.setDate(kyivNow.getDate()+1);
    document.getElementById('date').value = kyivNow.toISOString().slice(0,10);
    const hh = String(kyivNow.getHours()).padStart(2,'0');
    const mm = String(kyivNow.getMinutes()).padStart(2,'0');
    document.getElementById('time').value = `${hh}:${mm}`;

    // генерація лінка
    const out = document.getElementById('out');
    const openBtn = document.getElementById('open');
    const copyBtn = document.getElementById('copy');

    document.getElementById('make').onclick = () => {
      const date = document.getElementById('date').value;
      const time = document.getElementById('time').value;
      if(!date || !time){ out.textContent = 'Оберіть дату і час.'; return; }

      const fullName = document.getElementById('clientName').value.trim() || 'Клієнт';
      const email = document.getElementById('clientEmail').value.trim();

      const q = new URLSearchParams({
        consultant: myName,
        fullName,
        email,
        date,
        time
      }).toString();

      const zapisUrl = `${location.origin}${location.pathname.replace(/[^/]+$/,'')}zapis.html?${q}`;
      out.textContent = zapisUrl;

      openBtn.href = zapisUrl;
      openBtn.style.pointerEvents = 'auto';
      openBtn.style.opacity = '1';
      copyBtn.disabled = false;
    };

    document.getElementById('copy').onclick = async () => {
      if(out.textContent && navigator.clipboard){
        await navigator.clipboard.writeText(out.textContent);
        copyBtn.textContent = 'Скопійовано';
        setTimeout(()=> copyBtn.textContent='Скопіювати', 1200);
      }
    };

    // вихід
    document.getElementById('logout').onclick = () => {
      guard.logout();
    };
  </script>
</body>
</html>
