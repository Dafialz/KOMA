<script src="js/guard.js"></script>
<script>
  // 1) Захист сторінки
  guard.protect();

  // 2) Сесія + ім'я
  const me = guard.getSession();
  const myEmail = String(me.email || '').toLowerCase();
  const myName  = guard.emailToName(myEmail) || 'Консультант';

  // Профіль у правій колонці (твій існуючий блок)
  document.getElementById('who').textContent = `Користувач: ${myEmail}`;

  // 3) Ліва колонка «ВК»-профіль: ім'я/пошта
  document.getElementById('profName').textContent = myName;
  document.getElementById('profMail').textContent = myEmail;
  document.getElementById('clientsBtn').style.display = 'inline-flex';

  // 4) Аватар і галерея
  const AVATAR_MAP = {
    'oksanakokoten@gmail.com':  'icon/consultants/oksana.jpg',
    'sergiyoyovych@gmail.com':  'icon/consultants/sergi.jpg',
    'tetianaoyovych@gmail.com': 'icon/consultants/nastya.jpg',
    'oleksandrtkachuk@gmail.com':'icon/consultants/sasha.jpg',
    'anastasiyamakovska@gmail.com':'icon/consultants/tanya.jpg',
    'kristinakokoten@gmail.com':'icon/consultants/kris.jpg'
  };

  const GALLERY_MAP = {
    'oksanakokoten@gmail.com': [
      'icon/pro-nas/banda1.jpg','icon/pro-nas/banda2.jpg','icon/pro-nas/banda3.jpg'
    ],
    'sergiyoyovych@gmail.com': [
      'icon/pro-nas/banda4.jpg','icon/pro-nas/banda6.jpg'
    ],
    'tetianaoyovych@gmail.com': [
      'icon/pro-nas/banda5.jpg','icon/pro-nas/banda1.jpg'
    ],
    'oleksandrtkachuk@gmail.com': [
      'icon/pro-nas/banda2.jpg','icon/pro-nas/banda4.jpg'
    ],
    'anastasiyamakovska@gmail.com': [
      'icon/pro-nas/banda3.jpg','icon/pro-nas/banda5.jpg'
    ],
    'kristinakokoten@gmail.com': [
      'icon/pro-nas/koma.jpg','icon/pro-nas/koma-centr.jpg'
    ]
  };

  // Якщо галерея не задана, пробуємо icon/consultants/<base>-1..6.jpg
  function fallbackGallery(email){
    const avatar = AVATAR_MAP[email] || '';
    const baseName = avatar ? avatar.replace(/^.*\/([^/]+)\.jpg$/i, '$1') : 'oksana';
    const prefix = 'icon/consultants/';
    const arr = [];
    for (let i = 1; i <= 6; i++) arr.push(`${prefix}${baseName}${i}.jpg`);
    return arr;
  }

  const avatarEl = document.getElementById('avatar');
  avatarEl.src = AVATAR_MAP[myEmail] || 'icon/avatar.png';
  avatarEl.onerror = () => { avatarEl.src = 'icon/avatar.png'; };

  const gal = document.getElementById('gallery');
  const galleryList = (GALLERY_MAP[myEmail] && GALLERY_MAP[myEmail].length)
    ? GALLERY_MAP[myEmail]
    : fallbackGallery(myEmail);

  let shown = 0;
  galleryList.forEach(src => {
    const img = new Image();
    img.loading = 'lazy';
    img.src = src;
    img.alt = 'Фото';
    img.onerror = () => img.remove();
    img.onload = () => { gal.appendChild(img); shown++; document.getElementById('statPhotos').textContent = shown; };
  });

  // Плейсхолдери статистик
  document.getElementById('statToday').textContent   = 0;
  document.getElementById('statPlanned').textContent = 0;

  // 5) Дата/час за замовчуванням (Київ, +1 день)
  const kyivNow = new Date(new Date().toLocaleString('en-CA', { timeZone: 'Europe/Kyiv' }));
  kyivNow.setDate(kyivNow.getDate()+1);
  document.getElementById('date').value = kyivNow.toISOString().slice(0,10);
  const hh = String(kyivNow.getHours()).padStart(2,'0');
  const mm = String(kyivNow.getMinutes()).padStart(2,'0');
  document.getElementById('time').value = `${hh}:${mm}`;

  // 6) Генерація лінка
  const out = document.getElementById('out');
  const openBtn = document.getElementById('open');
  const copyBtn = document.getElementById('copy');

  document.getElementById('make').onclick = () => {
    const date = document.getElementById('date').value;
    const time = document.getElementById('time').value;
    if (!date || !time){ out.textContent = 'Оберіть дату і час.'; return; }

    const fullName = document.getElementById('clientName').value.trim() || 'Клієнт';
    const email = document.getElementById('clientEmail').value.trim();

    const q = new URLSearchParams({ consultant: myName, fullName, email, date, time }).toString();
    const zapisUrl = `${location.origin}${location.pathname.replace(/[^/]+$/,'')}zapis.html?${q}`;
    out.textContent = zapisUrl;

    openBtn.href = zapisUrl;
    openBtn.style.pointerEvents = 'auto';
    openBtn.style.opacity = '1';
    copyBtn.disabled = false;
  };

  document.getElementById('copy').onclick = async () => {
    if (out.textContent && navigator.clipboard){
      await navigator.clipboard.writeText(out.textContent);
      copyBtn.textContent = 'Скопійовано';
      setTimeout(() => copyBtn.textContent = 'Скопіювати', 1200);
    }
  };

  // 7) Вихід
  document.getElementById('logout').onclick = () => guard.logout();
</script>
