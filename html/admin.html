<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Кабінет консультанта — КОМА</title>
  <link rel="icon" href="icon/favicon.ico" />
  <meta name="theme-color" content="#0f5257" />
  <link rel="stylesheet" href="css/main.css" />

  <!-- Локальні стилі під «ВК»-макет -->
  <style>
    .vk-wrap{display:grid;grid-template-columns:280px 1fr;gap:18px}
    @media (max-width:980px){.vk-wrap{grid-template-columns:1fr}}
    .vk-card{background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
    .vk-profile{padding:16px}
    .vk-avatar{width:100%;aspect-ratio:1/1;border-radius:12px;object-fit:cover;background:#f3f4f6;border:1px solid var(--border)}
    .vk-name{font-weight:800;margin:10px 0 2px}
    .vk-mail{color:var(--muted);font-size:.95rem;word-break:break-all}
    .vk-actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .vk-stats{display:grid;grid-template-columns:repeat(3,1fr);border-top:1px solid var(--border)}
    .vk-stats div{padding:10px 8px;text-align:center}
    .vk-stats b{display:block;font-size:1.1rem}
    .vk-gallery{padding:12px;border-top:1px solid var(--border);display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .vk-gallery img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:10px;border:1px solid var(--border);background:#f6f7f8}
    .vk-title{margin:0 0 6px}
  </style>
</head>
<body>
  <div data-include="partials/header.html"></div>

  <section class="section">
    <div class="container vk-wrap">
      <!-- Ліва колонка: профіль + фото -->
      <aside class="vk-card">
        <div class="vk-profile">
          <img id="avatar" class="vk-avatar" src="icon/avatar.png" alt="Аватар консультанта">
          <h3 id="profName" class="vk-name">Консультант</h3>
          <div id="profMail" class="vk-mail">—</div>

          <div class="vk-actions">
            <a class="btn outline small" id="clientsBtn" href="clients.html">Клієнти</a>
            <button id="logout" class="btn gray small" type="button">Вийти</button>
          </div>
        </div>

        <div class="vk-stats">
          <div><b id="statToday">0</b><span class="muted">сьогодні</span></div>
          <div><b id="statPlanned">0</b><span class="muted">заплановано</span></div>
          <div><b id="statPhotos">0</b><span class="muted">фото</span></div>
        </div>

        <div class="vk-gallery" id="gallery"></div>
      </aside>

      <!-- Права колонка: існуючий функціонал -->
      <main class="grid g-2">
        <div class="card">
          <h2 class="vk-title">Вітаємо у кабінеті</h2>
          <p class="muted" id="who">—</p>
          <div class="pill" style="margin-top:10px">Статус доступу: <span id="status" class="ok">дозволено</span></div>
          <p class="muted" style="margin-top:10px">Ця сторінка доступна лише авторизованим асистентам «КОМА».</p>
        </div>

        <div class="card">
          <h3 class="vk-title">Згенерувати посилання на відеозустріч</h3>
          <div class="grid" style="grid-template-columns:1fr 1fr;gap:10px">
            <div>
              <label>Ім’я клієнта (для нотатки)</label>
              <input id="clientName" class="input" placeholder="Клієнт">
            </div>
            <div>
              <label>Ел. пошта клієнта (необов’язково)</label>
              <input id="clientEmail" class="input" type="email" placeholder="client@example.com">
            </div>
            <div>
              <label>Дата</label>
              <input id="date" class="input" type="date">
            </div>
            <div>
              <label>Час (Київ)</label>
              <input id="time" class="input" type="time">
            </div>
          </div>
          <div class="row" style="margin-top:12px">
            <button id="make" class="btn">Створити лінк</button>
            <button id="copy" class="btn gray" disabled>Скопіювати</button>
            <a id="open" class="btn ghost" href="#" target="_blank" rel="noopener" style="pointer-events:none;opacity:.6">Відкрити</a>
          </div>
          <p class="muted" id="out" style="margin-top:10px">—</p>
        </div>
      </main>
    </div>
  </section>

  <div data-include="partials/footer.html"></div>

  <script src="js/guard.js"></script>
  <script>
    // ===== Захист сторінки
    guard.protect();

    // ===== Сесія та базові дані користувача
    const sess    = guard.getSession();
    const myEmail = String(sess?.email || '').toLowerCase();   // <— є тепер ЗАВЖДИ
    const myName  = guard.emailToName(myEmail) || 'Консультант';

    // Відображення у правій колонці/профілі
    document.getElementById('who').textContent      = `Користувач: ${myEmail}`;
    document.getElementById('profName').textContent = myName;
    document.getElementById('profMail').textContent = myEmail;
    document.getElementById('clientsBtn').style.display = 'inline-flex';

    // ===== Мапи аватарів та галерей (під твою структуру icon/consultants/*)
    const AVATAR_MAP = {
      'oksanakokoten@gmail.com'   : 'icon/consultants/oksana.jpg',
      'sergiyoyovych@gmail.com'   : 'icon/consultants/sergi.jpg',
      'tetianaoyovych@gmail.com'  : 'icon/consultants/nastya.jpg',
      'oleksandrtkachuk@gmail.com': 'icon/consultants/sasha.jpg',
      'anastasiyamakovska@gmail.com': 'icon/consultants/tanya.jpg',
      'kristinakokoten@gmail.com' : 'icon/consultants/kris.jpg'
    };

    const GALLERY_MAP = {
      'oksanakokoten@gmail.com': [
        'icon/pro-nas/banda1.jpg','icon/pro-nas/banda2.jpg','icon/pro-nas/banda3.jpg'
      ],
      'sergiyoyovych@gmail.com': [
        'icon/pro-nas/banda4.jpg','icon/pro-nas/banda6.jpg'
      ],
      'tetianaoyovych@gmail.com': [
        'icon/pro-nas/banda5.jpg','icon/pro-nas/banda1.jpg'
      ],
      'oleksandrtkachuk@gmail.com': [
        'icon/pro-nas/banda2.jpg','icon/pro-nas/banda4.jpg'
      ],
      'anastasiyamakovska@gmail.com': [
        'icon/pro-nas/banda3.jpg','icon/pro-nas/banda5.jpg'
      ],
      'kristinakokoten@gmail.com': [
        'icon/pro-nas/koma.jpg','icon/pro-nas/koma-centr.jpg'
      ]
    };

    // Якщо для когось галерея не задана — шукаємо фото у вигляді icon/consultants/<ім’я>-1..6.jpg
    function fallbackGallery(email){
      const avatar = AVATAR_MAP[email] || '';              // напр. icon/consultants/oksana.jpg
      const stem   = avatar.replace(/\.jpg$/i,'');         // icon/consultants/oksana
      const root   = stem ? stem.replace(/[^/]+$/,'') : 'icon/consultants/'; // icon/consultants/
      const name   = stem ? stem.split('/').pop() : 'oksana';
      const arr=[]; for(let i=1;i<=6;i++) arr.push(`${root}${name}${i}.jpg`);
      return arr;
    }

    // Аватар
    const avatarEl = document.getElementById('avatar');
    avatarEl.src = AVATAR_MAP[myEmail] || 'icon/avatar.png';
    avatarEl.onerror = () => { avatarEl.src = 'icon/avatar.png'; };

    // Галерея
    const gal = document.getElementById('gallery');
    const galleryList = (GALLERY_MAP[myEmail] && GALLERY_MAP[myEmail].length)
      ? GALLERY_MAP[myEmail]
      : fallbackGallery(myEmail);

    let shown = 0;
    galleryList.forEach(src=>{
      const img = new Image();
      img.loading = 'lazy';
      img.src = src;
      img.alt = 'Фото';
      img.onerror = () => img.remove();
      img.onload  = () => { gal.appendChild(img); shown++; document.getElementById('statPhotos').textContent = shown; };
    });

    // Простенькі «статистики»
    document.getElementById('statToday').textContent   = 0;
    document.getElementById('statPlanned').textContent = 0;

    // ===== Дата/час за замовчуванням (сьогодні +1 день, таймзона Київ)
    const kyivNow = new Date(new Date().toLocaleString('en-CA', { timeZone: 'Europe/Kyiv' }));
    kyivNow.setDate(kyivNow.getDate()+1);
    document.getElementById('date').value = kyivNow.toISOString().slice(0,10);
    const hh = String(kyivNow.getHours()).padStart(2,'0');
    const mm = String(kyivNow.getMinutes()).padStart(2,'0');
    document.getElementById('time').value = `${hh}:${mm}`;

    // ===== Генерація лінку
    const out = document.getElementById('out');
    const openBtn = document.getElementById('open');
    const copyBtn = document.getElementById('copy');

    document.getElementById('make').onclick = () => {
      const date = document.getElementById('date').value;
      const time = document.getElementById('time').value;
      if(!date || !time){ out.textContent = 'Оберіть дату і час.'; return; }

      const fullName = (document.getElementById('clientName').value || '').trim() || 'Клієнт';
      const email    = (document.getElementById('clientEmail').value || '').trim();

      const q = new URLSearchParams({ consultant: myName, fullName, email, date, time }).toString();
      const zapisUrl = `${location.origin}${location.pathname.replace(/[^/]+$/,'')}zapis.html?${q}`;
      out.textContent = zapisUrl;

      openBtn.href = zapisUrl;
      openBtn.style.pointerEvents = 'auto';
      openBtn.style.opacity = '1';
      copyBtn.disabled = false;
    };

    document.getElementById('copy').onclick = async () => {
      if(out.textContent && navigator.clipboard){
        await navigator.clipboard.writeText(out.textContent);
        copyBtn.textContent = 'Скопійовано';
        setTimeout(()=> copyBtn.textContent='Скопіювати', 1200);
      }
    };

    // Вихід
    document.getElementById('logout').onclick = () => guard.logout();
  </script>
  <script src="js/partials.js"></script>
</body>
</html>
