<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Кабінет консультанта — КОМА</title>
  <link rel="icon" href="../icon/favicon.ico" />
  <meta name="theme-color" content="#0f5257" />
  <link rel="stylesheet" href="css/main.css">

  
</head>
<body>
  <div data-include="header.html"></div>

  <section class="section">
    <div class="container grid g-2">
      <div class="card">
        <h2 style="margin:0 0 6px">Вітаємо у кабінеті</h2>
        <p class="muted" id="who">—</p>
        <div class="pill" style="margin-top:10px">Статус доступу: <span id="status" class="ok">дозволено</span></div>
        <p class="muted" style="margin-top:10px">Ця сторінка доступна лише авторизованим асистентам «КОМА».</p>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px">Згенерувати посилання на відеозустріч</h3>
        <div class="grid" style="grid-template-columns:1fr 1fr;gap:10px">
          <div>
            <label>Ім’я клієнта (для нотатки)</label>
            <input id="clientName" class="input" placeholder="Клієнт">
          </div>
          <div>
            <label>Ел. пошта клієнта (необов’язково)</label>
            <input id="clientEmail" class="input" type="email" placeholder="client@example.com">
          </div>
          <div>
            <label>Дата</label>
            <input id="date" class="input" type="date">
          </div>
          <div>
            <label>Час (Київ)</label>
            <input id="time" class="input" type="time">
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <button id="make" class="btn">Створити лінк</button>
          <button id="copy" class="btn gray" disabled>Скопіювати</button>
          <a id="open" class="btn ghost" href="#" target="_blank" rel="noopener" style="pointer-events:none;opacity:.6">Відкрити</a>
        </div>
        <p class="muted" id="out" style="margin-top:10px">—</p>
      </div>
    </div>
  </section>

  <div data-include="footer.html"></div>

  <script src="js/guard.js"></script>
  <script>
    // захист сторінки
    guard.protect(); // редіректить на login.html, якщо немає сесії або email не з allowlist

    // футер
    // показ email/імені
    const me = guard.getSession();
    document.getElementById('who').textContent = `Користувач: ${me.email}`;
    const myName = guard.emailToName(me.email) || 'Консультант';

    // дефолтна дата/час (сьогодні + 1 день) — часова зона Києва
    const kyivNow = new Date(new Date().toLocaleString('en-CA', { timeZone: 'Europe/Kyiv' }));
    kyivNow.setDate(kyivNow.getDate()+1);
    document.getElementById('date').value = kyivNow.toISOString().slice(0,10);
    const hh = String(kyivNow.getHours()).padStart(2,'0');
    const mm = String(kyivNow.getMinutes()).padStart(2,'0');
    document.getElementById('time').value = `${hh}:${mm}`;

    // генерація лінка
    const out = document.getElementById('out');
    const openBtn = document.getElementById('open');
    const copyBtn = document.getElementById('copy');

    document.getElementById('make').onclick = () => {
      const date = document.getElementById('date').value;
      const time = document.getElementById('time').value;
      if(!date || !time){ out.textContent = 'Оберіть дату і час.'; return; }

      const fullName = document.getElementById('clientName').value.trim() || 'Клієнт';
      const email = document.getElementById('clientEmail').value.trim();

      const q = new URLSearchParams({
        consultant: myName,
        fullName,
        email,
        date,
        time
      }).toString();

      const zapisUrl = `${location.origin}${location.pathname.replace(/[^/]+$/,'')}zapis.html?${q}`;
      out.textContent = zapisUrl;

      openBtn.href = zapisUrl;
      openBtn.style.pointerEvents = 'auto';
      openBtn.style.opacity = '1';
      copyBtn.disabled = false;
    };

    document.getElementById('copy').onclick = async () => {
      if(out.textContent && navigator.clipboard){
        await navigator.clipboard.writeText(out.textContent);
        copyBtn.textContent = 'Скопійовано';
        setTimeout(()=> copyBtn.textContent='Скопіювати', 1200);
      }
    };

    // вихід
    document.getElementById('logout').onclick = () => {
      guard.logout();
    };
  </script>
  <script src="js/partials.js"></script>
</body>
</html>
