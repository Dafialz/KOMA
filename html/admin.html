<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Кабінет консультанта — КОМА</title>
  <link rel="icon" href="icon/favicon.ico" />
  <meta name="theme-color" content="#0f5257" />
  <link rel="stylesheet" href="css/main.css" />

  <!-- Локальні стилі під «ВК»-макет -->
  <style>
    .vk-wrap{display:grid;grid-template-columns:280px 1fr;gap:18px}
    @media (max-width:980px){.vk-wrap{grid-template-columns:1fr}}
    .vk-card{background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
    .vk-profile{padding:16px}
    /* Аватар без підрізання */
    .vk-avatar{
      width:100%;
      height:auto;
      object-fit:contain;
      background:#f3f4f6;
      border:1px solid var(--border);
      border-radius:12px;
      display:block;
    }
    .vk-name{font-weight:800;margin:10px 0 2px}
    .vk-mail{color:var(--muted);font-size:.95rem;word-break:break-all}
    .vk-actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}

    .vk-stats{display:grid;grid-template-columns:repeat(3,1fr);border-top:1px solid var(--border)}
    .vk-stats div{padding:10px 8px;text-align:center}
    .vk-stats b{display:block;font-size:1.1rem}

    /* Блок під кнопкою підтримки (замість галереї) */
    .vk-support{padding:12px;border-top:1px solid var(--border)}
    .w100{width:100%;justify-content:center}

    .vk-title{margin:0 0 6px}
  </style>
</head>
<body>
  <div data-include="partials/header.html"></div>

  <section class="section">
    <div class="container vk-wrap">
      <!-- Ліва колонка: профіль + кнопка підтримки -->
      <aside class="vk-card">
        <div class="vk-profile">
          <img id="avatar" class="vk-avatar" src="icon/avatar.png" alt="Аватар консультанта">
          <h3 id="profName" class="vk-name">Консультант</h3>
          <div id="profMail" class="vk-mail">—</div>

          <div class="vk-actions">
            <a class="btn outline small" id="clientsBtn" href="clients.html">Клієнти</a>
            <button id="logout" class="btn gray small" type="button">Вийти</button>
          </div>
        </div>

        <div class="vk-stats">
          <div><b id="statToday">0</b><span class="muted">сьогодні</span></div>
          <div><b id="statPlanned">0</b><span class="muted">заплановано</span></div>
          <div><b id="statPhotos">0</b><span class="muted">фото</span></div>
        </div>

        <!-- ЗАМІСТЬ ГАЛЕРЕЇ -->
        <div class="vk-support">
          <a id="supportBtn" class="btn outline w100" href="support.html">Служба підтримки</a>
        </div>
      </aside>

      <!-- Права колонка: існуючий функціонал -->
      <main class="grid g-2">
        <div class="card">
          <h2 class="vk-title">Вітаємо у кабінеті</h2>
          <p class="muted" id="who">—</p>
          <div class="pill" style="margin-top:10px">Статус доступу: <span id="status" class="ok">дозволено</span></div>
          <p class="muted" style="margin-top:10px">Ця сторінка доступна лише авторизованим асистентам «КОМА».</p>
        </div>

        <div class="card">
          <h3 class="vk-title">Згенерувати посилання на відеозустріч</h3>
          <div class="grid" style="grid-template-columns:1fr 1fr;gap:10px">
            <div>
              <label>Ім’я клієнта (для нотатки)</label>
              <input id="clientName" class="input" placeholder="Клієнт">
            </div>
            <div>
              <label>Ел. пошта клієнта (необов’язково)</label>
              <input id="clientEmail" class="input" type="email" placeholder="client@example.com">
            </div>
            <div>
              <label>Дата</label>
              <input id="date" class="input" type="date">
            </div>
            <div>
              <label>Час (Київ)</label>
              <input id="time" class="input" type="time">
            </div>
          </div>
          <div class="row" style="margin-top:12px">
            <button id="make" class="btn">Створити лінк</button>
            <button id="copy" class="btn gray" disabled>Скопіювати</button>
            <a id="open" class="btn ghost" href="#" target="_blank" rel="noopener" style="pointer-events:none;opacity:.6">Відкрити</a>
          </div>
          <p class="muted" id="out" style="margin-top:10px">—</p>
        </div>
      </main>
    </div>
  </section>

  <div data-include="partials/footer.html"></div>

  <script src="js/guard.js"></script>
  <script>
    // ===== Захист сторінки
    guard.protect();

    // ===== Сесія та базові дані користувача
    const sess    = guard.getSession();
    const myEmail = String(sess?.email || '').toLowerCase();
    const myName  = guard.emailToName(myEmail) || 'Консультант';

    // Відображення у правій колонці/профілі
    document.getElementById('who').textContent      = `Користувач: ${myEmail}`;
    document.getElementById('profName').textContent = myName;
    document.getElementById('profMail').textContent = myEmail;
    document.getElementById('clientsBtn').style.display = 'inline-flex';

    // ===== Мапи аватарів під структуру icon/consultants/*
    const AVATAR_MAP = {
      'oksanakokoten@gmail.com'   : 'icon/consultants/oksana.jpg',
      'sergiyoyovych@gmail.com'   : 'icon/consultants/sergi.jpg',
      'anastasiyoyovych@gmail.com': 'icon/consultants/nastya.jpg',
      'oleksandrtkachuk@gmail.com': 'icon/consultants/sasha.jpg',
      'tetianamakovska@gmail.com' : 'icon/consultants/tanya.jpg',
      'kristinakokoten@gmail.com' : 'icon/consultants/kris.jpg',
      'dafialz@gmail.com'         : 'icon/support-bot.svg'
    };

    // Аватар (з фолбеком)
    const avatarEl = document.getElementById('avatar');
    avatarEl.src = AVATAR_MAP[myEmail] || 'icon/avatar.png';
    avatarEl.onerror = () => { avatarEl.src = 'icon/avatar.png'; };

    // Статистика «фото» тепер 0 (бо галереї немає)
    document.getElementById('statPhotos').textContent = 0;

    // ===== Дата/час за замовчуванням (Київ, завтра)
    function kyivDateTime(offsetDays = 1) {
      const now = new Date();
      const fmt = new Intl.DateTimeFormat('uk-UA', {
        timeZone: 'Europe/Kyiv',
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', hour12: false
      });
      const parts = Object.fromEntries(fmt.formatToParts(now).map(p => [p.type, p.value]));
      const base = new Date(`${parts.year}-${parts.month}-${parts.day}T${parts.hour}:${parts.minute}:00`);
      base.setDate(base.getDate() + offsetDays);

      const Y  = base.getFullYear();
      const M  = String(base.getMonth() + 1).padStart(2,'0');
      const D  = String(base.getDate()).padStart(2,'0');
      const HH = String(base.getHours()).padStart(2,'0');
      const MM = String(base.getMinutes()).padStart(2,'0');

      return { date: `${Y}-${M}-${D}`, time: `${HH}:${MM}` };
    }
    const def = kyivDateTime(1);
    document.getElementById('date').value = def.date;
    document.getElementById('time').value = def.time;

    // ===== Генерація лінку
    const out = document.getElementById('out');
    const openBtn = document.getElementById('open');
    const copyBtn = document.getElementById('copy');

    document.getElementById('make').onclick = () => {
      const date = document.getElementById('date').value;
      const time = document.getElementById('time').value;
      if(!date || !time){ out.textContent = 'Оберіть дату і час.'; return; }

      const fullName = (document.getElementById('clientName').value || '').trim() || 'Клієнт';
      const email    = (document.getElementById('clientEmail').value || '').trim();

      const q = new URLSearchParams({ consultant: myName, fullName, email, date, time }).toString();
      const zapisUrl = `${location.origin}${location.pathname.replace(/[^/]+$/,'')}zapis.html?${q}`;
      out.textContent = zapisUrl;

      openBtn.href = zapisUrl;
      openBtn.style.pointerEvents = 'auto';
      openBtn.style.opacity = '1';
      copyBtn.disabled = false;
    };

    document.getElementById('copy').onclick = async () => {
      if(out.textContent && navigator.clipboard){
        await navigator.clipboard.writeText(out.textContent);
        copyBtn.textContent = 'Скопійовано';
        setTimeout(()=> copyBtn.textContent='Скопіювати', 1200);
      }
    };

    // Вихід
    document.getElementById('logout').onclick = () => guard.logout();
  </script>
  <script src="js/partials.js"></script>
</body>
</html>
